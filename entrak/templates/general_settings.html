{% extends "page_base.html" %}

{% load static %}
{% load entrak_extras %}

{% block extra_head %}
{{block.super}}

<link rel="stylesheet" type="text/css" href="{% static 'css/general-settings.css' %}">
<script src="{% static 'js/jquery-cookie-master/jquery.cookie.js' %}"></script>
<script src="{% static 'js/csrf_ajax.js' %}"></script>
<script src="{% static 'js/mustache.js-master/mustache.js' %}"></script>
{% endblock %}

{% block page_title %}THE SETTINGS PAGE{% endblock %}
{% block page_subtitle %}Find out what you can set here at{% endblock %}

{% block extra_script %}
{{block.super}}

<script id="accrount-row-template" type="x-tmpl-mustache">
<div class="account-row">
	<div class="ar-label-col"><input type="text" name="label">
	</div><div class="ar-user-col"><input type="text" name="username">
	</div><div class="ar-email-col"><input type="email" name="email">
	</div><div class="ar-pwd-col"><div class="change-pwd-btn">Change Password</div>
	</div><div class="ar-action-col">
		<div class="ar-apply-btn">Apply</div>
		<div class="ar-cancel-btn">Cancel</div>
	</div>
</div>
</script>

<script type="text/javascript">

USER_ROLE_ADMIN_LEVEL	= 100
USER_ROLE_VIEWER_LEVEL	= 1
USER_TYPE_STANDARD = 'standard'
USER_TYPE_ADMIN = 'admin'

settings = {};

function userTypeToRoleLevel(userType) {
	var roleLevel;
	if (userType === USER_TYPE_STANDARD) {
		roleLevel = USER_ROLE_VIEWER_LEVEL;
	} else if (userType === USER_TYPE_ADMIN) {
		roleLevel = USER_ROLE_ADMIN_LEVEL;
	}

	return roleLevel;
}

function roleLevelToUserType(roleLevel) {
	var userType;
	if (roleLevel === USER_ROLE_ADMIN_LEVEL) {
		userType = USER_TYPE_ADMIN;
	} else if (roleLevel === USER_ROLE_VIEWER_LEVEL) {
		userType = USER_TYPE_STANDARD;
	}

	return userType;
}

function getUserById(userId) {
	var matchUser = null;
	$.each(settings.users, function(userIdx, userItem) {
		if (userId === userItem.id) {
			matchUser = userItem;
			return false;
		}
	});

	return matchUser;
}

function setupAccountRowCancelBtn(targetEle) {
	targetEle.click(function() {
		var accountRow = targetEle.parent().parent();
		var user = getUserById(parseInt(accountRow.attr('user_id'), 10));

		accountRow.find('.ar-user-col input').val(user.userName);
		accountRow.find('.ar-pwd-col input').val('');
		accountRow.find('.ar-type-sel').val(roleLevelToUserType(user.roleLevel));
	});
}

function insertAccountRow(user, accountTemplate, targetEle) {
	var eleHtml = $(Mustache.render(accountTemplate, {}));
	eleHtml.attr('user_id', user.id);
	eleHtml.find('.ar-user-col input').val(user.userName);

	targetEle.append(eleHtml);
}

$(function() {
	settings.adminUsers = JSON.parse('{{admin_user_info|jsonifyPrimitiveObj}}');
	settings.generalUsers = JSON.parse('{{general_user_info|jsonifyPrimitiveObj}}');

	var accountRowTemplate = $('#accrount-row-template').html();
	Mustache.parse(accountRowTemplate);
	$.each(settings.adminUsers, function(userIdx, userItem) {
		insertAccountRow(userItem, accountRowTemplate, $('.admin-acconut-table'));
	});
	$.each(settings.generalUsers, function(userIdx, userItem) {
		insertAccountRow(userItem, accountRowTemplate, $('.general-acconut-table'));
	});

	setupAccountRowCancelBtn($('.ar-cancel-btn'));
});

</script>

{% endblock %}

{% block page_content %}

<div class="account-section settings-section">
	<div class="section-header">Manage Accounts</div>
	<div class="section-desc">Use the form below to manage or create new user accounts</div>
	<div class="admin-account-title">Admin Account</div>
	<div class="account-table admin-acconut-table">
		<div class="account-th">
			<div class="account-th-label">Label
			</div><div class="account-th-name">Username
			</div><div class="account-th-email">Recovering Email
			</div><div class="account-th-pwd">Password
			</div><div class="account-th-actions">Actions</div>
		</div>
	</div>

	<hr>
	<div class="general-account-header">
		<div class="admin-account-title">User Account</div>
		<div class="add-account-btn-block">
			<div class="add-account-btn">Add New Account</div>
			<div class="add-account-note">All fields are required</div>
		</div>
	</div>
	
	<div class="account-table general-acconut-table">
		<div class="account-th">
			<div class="account-th-label">Label
			</div><div class="account-th-name">Username
			</div><div class="account-th-email">Recovering Email
			</div><div class="account-th-pwd">Password
			</div><div class="account-th-actions">Actions</div>
		</div>
	</div>

</div>

{% endblock %}
