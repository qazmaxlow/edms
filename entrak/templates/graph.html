{% extends "base.html" %}

{% load static %}
{% load staticfiles %}

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/main.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/graph.css' %}">
<link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
<link rel="stylesheet" type="text/css" href="{% static 'js/superfish-master/dist/css/superfish.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'js/datetimepicker-master/jquery.datetimepicker.css' %}">
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
<script src="{% static 'js/arboreal.js' %}"></script>
<script src="{% static 'js/flot/jquery.flot.min.js' %}"></script>
<script src="{% static 'js/growraf/jquery.flot.growraf.js' %}"></script>
<script src="{% static 'js/tooltip/jquery.flot.tooltip.min.js' %}"></script>
<script src="{% static 'js/flot/jquery.flot.selection-customized.js' %}"></script>
<script src="{% static 'js/moment.min.js' %}"></script>
<script src="{% static 'js/superfish-master/dist/js/superfish.min.js' %}"></script>
<script src="{% static 'js/morris.js-0.4.3/raphael-min.js' %}"></script>
<script src="{% static 'js/morris.js-0.4.3/morris-customized.js' %}"></script>
<script src="{% static 'js/datetimepicker-master/jquery.datetimepicker-customized.js' %}"></script>
<script src="{% static 'js/graph.js' %}"></script>

<script type="text/javascript">

var graph = null;

function updateDonutChart(data) {
	$("#selection-summary-chart").empty();
	var donutChart = Morris.Donut({
		element: 'selection-summary-chart',
		data: data,
		colors: ['#FFAE20', '#EF7C56', '#35BC99', '#C94CD7', '#587EFF'],
		labelColors: ['#FFAE20', '#EF7C56', '#35BC99', '#C94CD7', '#587EFF'],
		formatter: function (x) { return x + "%"}
	});
	donutChart.on('select', function(i, row){
		$("#selection-summary-value").text(row.orgValue.toFixed(0));
		$("#selection-summary-unit").text(graph.currentUnit);
		$("#selection-summary-source").text(row.label);
	});
	donutChart.fire("select", 0, data[0]);
}

function formatDtAtStr(dt, rangeType) {
	var formatStr = null;
	if (rangeType === graph.RANGE_TYPE_HOUR
		|| rangeType === graph.RANGE_TYPE_DAY
		|| rangeType === graph.RANGE_TYPE_NIGHT) {
		formatStr = 'D MMM YYYY, ddd';
	} else if (rangeType === graph.RANGE_TYPE_WEEK) {
		formatStr = 'D MMM YYYY';
	} else if (rangeType === graph.RANGE_TYPE_MONTH) {
		formatStr = 'MMM YYYY';
	}

	return (formatStr !== null) ? dt.format(formatStr) : '';
}

function formatCurrentDtStr(dt, rangeType) {
	var formatStr = null;
	if (rangeType === graph.RANGE_TYPE_HOUR
		|| rangeType === graph.RANGE_TYPE_DAY
		|| rangeType === graph.RANGE_TYPE_NIGHT
		|| rangeType === graph.RANGE_TYPE_WEEK) {
		formatStr = 'D MMM YYYY, ddd';
	} else if (rangeType === graph.RANGE_TYPE_MONTH) {
		formatStr = 'MMM YYYY';
	} else if (rangeType === graph.RANGE_TYPE_YEAR) {
		formatStr = 'YYYY';
	}

	return dt.format(formatStr);
}

function formatDtFromToStr(dt, rangeType) {
	var formatStr = null;
	if (rangeType === graph.RANGE_TYPE_HOUR
		|| rangeType === graph.RANGE_TYPE_DAY
		|| rangeType === graph.RANGE_TYPE_NIGHT) {
		formatStr = 'hh:mma';
	} else if (rangeType === graph.RANGE_TYPE_WEEK) {
		formatStr = 'ddd';
	} else if (rangeType === graph.RANGE_TYPE_MONTH) {
		formatStr = 'D';
	} else if (rangeType === graph.RANGE_TYPE_YEAR) {
		formatStr = 'MMM';
	}

	return dt.format(formatStr);
}

function updateSelectSystem(node) {
	var breadcrumbs = $("#breadcrumbs");
	breadcrumbs.empty();
	var targetNode = node;
	while(targetNode !== null) {
		var pDom = $("<p> " + targetNode.data.name + " </p>")
			.click({node: targetNode}, function(event) {
				updateSelectSystem(event.data.node);
			});
		breadcrumbs.prepend(pDom);

		if (targetNode.parent !== null) {
			breadcrumbs.prepend("<img class=\"next\" src=\"{% static 'images/next-icon.png' %}\">");
		}
		
		targetNode = targetNode.parent;
	}

	graph.selectSystem(node);
}

function updateCurrentDtText() {
	$("#current-dt").text(' ' + formatCurrentDtStr(graph.currentDt, graph.currentRangeType) + ' ');
}

function resetGraphNPanel() {
	updateCurrentDtText();

	$("#x-axis-slider").slider("values", [0, 0]);

	var selectionSummary = $("#selection-summary");
	if (selectionSummary.css('display') !== 'none') {
		selectionSummary.fadeOut();
	}

	if (graph.plot !== null) {
		graph.plot.setSelection({
			xaxis: {
				from: 0,
				to: 0,
			}
		});
	}
}

function getNowMoment() {
	// TODO: hardcode now
	// return moment().startOf('hour');
	return moment().year(2014).month(5).date(3).startOf('hour');
}

function retrieveReadingFinished() {
	resetGraphNPanel();
}

function retrieveSummaryFinished() {
	$("#last-consumption-val").text(graph.lastConsumption.toFixed(0));
	$("#this-consumption-val").text(graph.realtimeConsumption.toFixed(0));

	var diffPercentage = (((graph.realtimeConsumption - graph.lastConsumption)/graph.realtimeConsumption)*100).toFixed(1);
	$("#summary-percentage span").text(diffPercentage);

	setTimeout(function() {
		graph.getSummary(retrieveSummaryFinished);
	}, 60000);
}

$(function() {

	graph = new Graph(
		"#chart",
		"#source-choice",
		"#y-axis-slider",
		"#x-axis-slider",
		retrieveReadingFinished);
	graph.currentRangeType = graph.RANGE_TYPE_DAY;
	graph.currentDt = getNowMoment();
	graph.currentUnit = graph.UNIT_KWH;

	{% for system in systems %}
		var system = {};
		system.code = '{{system.code}}';
		system.name = '{{system.name}}';
		system.path = '{{system.path}}';
		system.sources = {};
		if (system.path == 'None') {
			graph.systemTree = new Arboreal(null, system);
		} else {
			parentCodes = $(system.path.split(',')).filter(function(){
				return this != "";
			});
			parentCode = parentCodes[parentCodes.length - 1];
			parentNode = graph.systemTree.find(function (node) {
				return node.data.code == parentCode;
			});
			parentNode.appendChild(system);
		}
	{% endfor %}
	graph.currentSelectedSystem = graph.systemTree;

	{% for source in sources %}
		var source = {};
		source.name = '{{source.d_name}}';
		source.name_tc = '{{source.d_name_tc}}';
		source.order = '{{source.order}}';
		source.units = {};

		{% for category, cat_id in source.units.items %}
			source.units['{{category}}'] = {{cat_id}};
		{% endfor %}

		graph.addSourceToSystem('{{source.system_code}}', '{{source.id}}', source);
	{% endfor %}

	var unitCategorys = [];
	// kwh is default unit
	graph.units.push({
		category: 'kwh',
		catName: 'kwh',
		imgOff: 'kwh-unit-off.png',
		imgOn: 'kwh-unit-on.png',
	});
	{% for unit in units %}
		var unit = {};
		unit.category = '{{unit.category}}';
		unit.catName = '{{unit.cat_name}}';
		unit.catId = {{unit.cat_id}};
		unit.name = '{{unit.name}}';
		unit.rate = {{unit.rate}};
		unit.effectiveDate = moment.unix({{unit.effective_date|date:"U"}});
		unit.order = {{unit.order}};
		unit.imgOff = '{{unit.img_off}}';
		unit.imgOn = '{{unit.img_on}}';

		graph.units.push(unit);
	{% endfor %}

	$("#y-axis-slider").slider({
		orientation: "vertical",
		animate: "fast",
		create: function(event, ui) {
			var wrapDiv = $('<div>')
			wrapDiv.append($(this).find('a'));
			$(this).append(wrapDiv);
		}
	});

	$("#x-axis-slider").slider({
		range: true,
		min: 0,
		values: [0, 0],
		step: 1,
		animate: "fast",
	});
	graph.xAxisSliderCallback = function (ranges, fromDt, toDt, data) {
		var selectionSummary = $("#selection-summary");
		if (fromDt.unix() === toDt.unix()) {
			if (selectionSummary.css('display') !== 'none') {
				selectionSummary.fadeOut();
			}
		} else {
			if (selectionSummary.css('display') === 'none') {
				selectionSummary.fadeIn();
			}
			$("#selection-summary-at span").text(formatDtAtStr(graph.currentDt, graph.currentRangeType));
			$("#selection-summary-from span").text(formatDtFromToStr(fromDt, graph.currentRangeType));
			$("#selection-summary-to span").text(formatDtFromToStr(toDt, graph.currentRangeType));

			var total = data.reduce(function (previousVal, current, index, array) {
				return previousVal + current.value;
			}, 0);
			var transformedData = data.map(function (seriesData) {
				var percentage = Math.round((seriesData.value/total)*1000)/10;
				return {label: seriesData.label, value: percentage, orgValue: seriesData.value};
			});
			transformedData.sort(function (a, b) {
				return b.orgValue - a.orgValue;
			});
			updateDonutChart(transformedData);
		}
	};

	var subMenuPanel = $("#sub-menu-links ul");
	var subMenu = $("#sub-menu h3").each(function (eleIdx) {
		$(this).click({connectedPanel: subMenuPanel[eleIdx]}, function (event) {
			var connectedPanel = $(event.data.connectedPanel);
			if (!(connectedPanel.hasClass('selected-submenu'))) {
				subMenuPanel.filter(".selected-submenu").removeClass('selected-submenu').hide();
				connectedPanel.addClass('selected-submenu').fadeIn();
			}

			var menuLinks = $('#sub-menu-links');
			if (menuLinks.css("display") === 'none') {
				menuLinks.slideToggle(700, "easeOutBounce", function() {});
			}
		});
	});
	$("#unit-choice").addClass('selected-submenu').show();

	$('#expand-menu-btn').click(function () {
		var menuLinks = $('#sub-menu-links');
		if (menuLinks.css('display') === 'none') {
			$(this).css({transform: 'rotate(180deg)'});
		} else {
			$(this).css({transform: 'rotate(0deg)'});
		}
		menuLinks.slideToggle(700, "easeOutBounce", function() {});
	});

	var distinctUnitCategorys = [];
	var unitChoice = $('#unit-choice');
	$.each(graph.units, function(idx, unit) {
		if ($.inArray(unit.category, distinctUnitCategorys) === -1) {
			distinctUnitCategorys.push(unit.category);
			var unitLiDom = $("<li unit_category='" + unit.category + "'>"
				+ "<img src='{% get_static_prefix %}images/unit/" + unit.imgOff + "'>"
				+ "</li>");
			unitLiDom.find('img').hover(function() {
				$(this).attr("src", "{% get_static_prefix %}images/unit/" + unit.imgOn);
			}, function() {
				$(this).attr("src", "{% get_static_prefix %}images/unit/" + unit.imgOff);
			});
			unitChoice.append(unitLiDom);
		}
	});
	unitChoice.find("li").click(function () {
		graph.updateUnit($(this).attr("unit_category"));
	});

	var timeRangeTypes = [graph.RANGE_TYPE_DAY, graph.RANGE_TYPE_NIGHT,
		graph.RANGE_TYPE_WEEK, graph.RANGE_TYPE_MONTH,
		graph.RANGE_TYPE_YEAR, graph.RANGE_TYPE_HOUR];
	var timeChoice = $("#time-choice");
	$.each(timeRangeTypes, function(idx, rangeType) {
		var timeLiDom = $("<li id='time-choice-" + rangeType + "-icon' range_type='" + rangeType + "'></li>");
		// timeChoice.append(timeLiDom);
		timeLiDom.insertBefore("#select-dt-section");
	})
	timeChoice.find("li").click(function () {
		var newRangeType = $(this).attr("range_type");
		if (graph.currentRangeType !== newRangeType) {
			graph.currentDt = graph.genStartEndDt(getNowMoment(), newRangeType).startDt;
			graph.updateCurrentRangeType(newRangeType);
			resetGraphNPanel();
		}
	});

	graph.getSourceReadings();

	var menuTreeDom = null;
	graph.systemTree.traverseDown(function (node) {
		var aDom = $('<a href="#" onclick="return false;">' + node.data.name +'</a>');
		aDom.click({node: node}, function(event) {
			updateSelectSystem(event.data.node);
		});
		var appendDom = $('<li system_code="' + node.data.code + '">');
		appendDom.append(aDom);

		var parentNode = node.parent;
		if (parentNode !== null) {
			var targetDom = null;
			var parentDom = menuTreeDom.find('*').andSelf().filter("li[system_code='" + parentNode.data.code + "']");
			var ulDoms = parentDom.find("> ul");
			if (ulDoms.length === 0) {
				targetDom = $("<ul></ul>");
				parentDom.append(targetDom);
			} else {
				targetDom = ulDoms;
			}

			targetDom.append(appendDom);
		} else {
			menuTreeDom = appendDom;
		}
	});
	$("#system-menu ul").append(menuTreeDom);

	$('#system-menu').superfish({
	});

	Date.parseDate = function( input, format ){
		return moment(input,format).toDate();
	};
	Date.prototype.dateFormat = function( format ){
		return moment(this).format(format);
	};
	var dtPickerFormat = "D MMM YYYY, dddd";
	$("#current-dt-picker").datetimepicker({
		format: dtPickerFormat,
		formatTime: "h:mm a",
		formatDate: "DD.MM.YYYY",
		scrollMonth: false,
		timepicker: false,
		onSelectDate: function(input) {
			graph.updateCurrentDt(moment(input).startOf('hour'));
			resetGraphNPanel();
		}
	});

	$("#calendar").click(function () {
		$('#current-dt-picker').datetimepicker('show');
	})

	$("#dt-prev-icon").click(function () {
		graph.goPrev();
		resetGraphNPanel();
	});
	$("#dt-next-icon").click(function () {
		graph.goNext();
		resetGraphNPanel();
	});
	$("#dt-now-icon").click(function() {
		graph.updateCurrentDt(getNowMoment());
		resetGraphNPanel();
	});

	$("#clear-graph").click(function () {
		resetGraphNPanel();
	});

	updateSelectSystem(graph.systemTree);
	resetGraphNPanel();

	graph.getSummary(retrieveSummaryFinished);
});

</script>
{% endblock %}

{% block content %}

<div id="page-container">

	<!-- Left Sidebar Main -->
	<div id="menu">

		<!-- User's Company Logo -->			
		<div id="users-logo">
			<img src="{% static 'images/users-logo-bg.png' %}" width="187" height="201" usemap="#config">
			
			<map name="config">
				<area shape="circle" coords="164,22,25" href="#" alt="config">
			</map>
		</div>
				
		<!-- User's Company Name -->
		<h2 id="company">OTIS WORLD WIDE</h2>
		
		<!-- Admin - Logout - Settings -->
		<div id="admin">
			<a href="#">
				<div id="logout"><p>Logout</p></div>
			</a>
			<a href="#">
				<div id="settings"><p>Settings</p></div>
			</a>
		</div>

		<!-- Main Sidebar Links -->
		<nav>
			<ul id="menu-links">
				<li>
					<a href="#"><img width="26" height="22" src="{% static 'images/home-icon.png' %}"><span>Home</span></a>
				</li>
				<li>
					<a href="#"><img width="26" height="22" src="{% static 'images/graph-icon.png' %}"><span>Graph</span></a>
				</li>

				<li>
					<a href="#"><img width="26" height="23" src="{% static 'images/ranking-icon.png' %}"><span>Ranking</span></a>
				</li>
				<li>
					<a href="#"><img width="26" height="24" src="{% static 'images/reports-icon.png' %}"><span>Reports</span></a>
				</li>
				<li>
					<a href="#"><img width="26" height="22" src="{% static 'images/display-icon.png' %}"><span>Display</span></a>
				</li>
				<li>
					<a href="#"><img width="31" height="21" src="{% static 'images/prov-icon.png' %}"><span>Pro V</span></a>
				</li>
			</ul>
		</nav>

	</div>	
	<!-- Left Sidebar Main End -->
	
	<!-- Main Content -->
	<div class="right-content">
		
		<!-- Blue Bar top -->
		<div class="blue-bar"></div>

		<!-- Header -->
		<div id="header">

			<!-- Image Carousel - Illustrations -->
			<div id="image-carousel"></div>
			
			<!-- Header Wording -->
			<div id="heading"><h1> Graph - Days </h1></div>
			<div id="sub-heading"><h2> Check this out!</h2></div>

		</div>
		<!-- Header End -->
		
		<!-- Blue Bar bottom -->
		<div class="blue-bar"></div>

		<div id="sub-heading-facilities">
			<span><h3>You are at:</h3></span>
			<span id="breadcrumbs-path">
				<span style="font-weight: 200; color:#cedee2;">OTIS World Wide</span>
				<span>-</span>
				<span>Kowloon Bay</span>
			</span>
		</div>

		<div class="graph-component">
			<div id="graph-panel-header">
				<!-- Sub Menu Item -->
				<div id="sub-menu">
					<!-- write this way to remove space between inline-blocks -->
					<!-- http://css-tricks.com/fighting-the-space-between-inline-block-elements/ -->
					<h3 id="sub-menu-unit">
						Unit</h3><h3 id="sub-menu-time">
						Time</h3><h3 id="sub-menu-source">
						Source</h3><h3 id="sub-menu-days">Days</h3>
					<img id="expand-menu-btn" src="{% static 'images/expandable_button.png' %}">
				</div>

				<!-- Date -->
				<p id="dt-panel">
					<img id="dt-next-icon">
					<img id="dt-now-icon">
					<img id="dt-prev-icon">
					<span id="current-dt"></span>
					<span style='clear: both;'></span>				
				</p>
			</div>

			<!-- Sub Menu Item Links -->
			<div id="sub-menu-links">
				<ul id="unit-choice"></ul>
				<ul id="time-choice">
					<div id="select-dt-section">
						<div>CUSTOM SELECT</div>
						<img id="calendar">
						<input type="text" id="current-dt-picker">
					</div>
				</ul>
				<ul id="source-choice"><div id="source-choice"></div></ul>
				<ul id="day-choice"></ul>
			</div>
			<div style="clear: both;"></div>

			<!-- Simple bar for decoration -->
			<div id="main-graph-bar"></div>
		</div>

		<!-- Main Graph -->
		<div id="graph-panel" class="graph-component">

			{% comment %}
			<!-- Sub Level -->
			<ul id="system-menu" class="sf-menu">
				<li>
					<a><img id="system-menu-icon"></a>
					<ul></ul>
				</li>
			</ul>
			<!-- Breadcrumbs -->
			<div id="breadcrumbs"></div>
			<!-- Calendar -->
			<input type="text" id="current-dt-picker">
			<img id="calendar">
			
			<!-- Clear Graph -->
			<img id="clear-graph">
			<div style="clear: both;"></div>
			{% endcomment %}
			
			<div id="chart"></div>
			<div id="y-axis-slider"></div>
			<div id="x-axis-slider"></div>

			<div id="selection-summary">
				<div id="selection-summary-left">
					<p id="selection-summary-at">Amount of energy consumed on:<span></span></p>
					<p id="selection-summary-from">from:<span></span></p>
					<p id="selection-summary-to">to:<span></span></p>
					<p id="selection-summary-equal">which equates to:</p>
					<p id="selection-summary-value-container">
						<span id="selection-summary-value"></span>
						<span id="selection-summary-unit"></span>
					</p>
				</div>
				<div id="selection-summary-right">
					<div id="selection-summary-chart"></div>
					<p id="selection-summary-source"></p>
				</div>
				<p style="clear: both;"></p>
			</div>
		</div>
		<!-- Main Graph Ends -->

		<!-- Summary -->
		<div id="summary">
			<div id="summary-header"><img src="{% static 'images/summary.png' %}"></div>

			<div id="summary-image">
				<div id="last-summary">
					<p class="summary-text">This time last week you had used </p>
					<img class="electricity-icon" src="{% static 'images/red-electricity.png' %}">
					<span id="last-consumption-val" class="consumption-val"></span><span class="consumption-unit">kwh</span>
				</div>

				<div id="this-summary">
					<p class="summary-text">So far today you have used </p>
					<img class="electricity-icon" src="{% static 'images/green-electricity.png' %}">
					<span id="this-consumption-val" class="consumption-val"></span><span class="consumption-unit">kwh</span>
				</div>

				<div id="summary-percentage">
					<span></span><img id="percentage-icon" src="{% static 'images/percentage.png' %}">
				</div>
			</div>
		</div>
		<!-- Summary Ends -->

	</div>
	<!-- Main Content Ends -->
</div>
<!-- Page Container Ends -->

<!-- Footer  -->
<footer class="site-footer">
	<p style="clear: both;"></p>
	<p id="copyright">Copyright © En-trak Pte Ltd 2014. All rights reserved.</p>
	<a href="#"><img id="entrak-logo" src="{% static 'images/entrakLogo.png' %}"></a>
	<p id="disclaimer_main"><a class="disclaimer" href="#">Print </a>
	<a class="disclaimer" href="#"> |  Contact & Support</a>
	<a class="disclaimer" href="#"> |  Settings</a>
	<a href="#" class="disclaimer"> |  Legal </a>
	<a class="disclaimer" href="#"> |  Download</a></p>				
	<p style="clear: both;"></p>
</footer>

{% endblock %}
