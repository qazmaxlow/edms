{% extends "page_base.html" %}

{% load i18n %}
{% load entrak_extras %}
{% load static %}
{% load humanize %}

{% block ga_page_title %}report{% endblock %}

{% block extra_head %}
{{block.super}}
{% get_current_language as LANGUAGE_CODE %}

<link rel="stylesheet" type="text/css" href="{% static 'css/drop-down-panel.css' %}">

<script src="{% static 'js/jquery-cookie-master/jquery.cookie.js' %}"></script>
<script src="{% static 'assets/django/js/ajax.js' %}"></script>
<script src="{% static 'js/moment-with-locales.js' %}"></script>
<script src="{% static 'js/moment-timezone-with-data.min.js' %}"></script>
<script src="{% static 'js/entrak-system.js' %}"></script>
<script src="{% static 'js/entrak-utils.js' %}"></script>

<link href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'css/tmp/bootstrap_hack.css' %}" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="{% static 'css/custom_control.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/manage_account.css' %}">

<script src="{% static 'assets/etkendoui/js/et.dropdown.js' %}"></script>
<script src="{% static 'assets/etkendoui/js/cultures/kendo.culture.en-US.js' %}"></script>
<script src="{% static 'assets/etkendoui/js/cultures/kendo.culture.zh-TW.js' %}"></script>


{% endblock %}

{% block page_title %}{% trans "THE SETTINGS PAGE" %}{% endblock %}
{% block page_subtitle %}{% trans "Find out what you can set here at" %}{% endblock %}

{% block extra_script %}
{{block.super}}
{% endblock %}

{% block page_content %}

{% verbatim %}

<div id="myApp" ng-app="Entrak">
    <div ng-controller="myCtrl" class="manage-acc">
        <div class="k-header">
            <div class="header-tab">My Profile</div><!--
            --><div class="header-tab selected-tab">Manage Accounts</div>
        </div>

        <button class='k-button normal-btn userAcc' ng-click="showCreateUserAccountWindow()">Create User Account</button>
        <kendo-grid options="priGridOptions">
        </kendo-grid>
        <div kendo-window="createUserAccountWindow" id="createUserAccountWindow" k-title="'Create Account'" k-width="400" k-height="226" k-visible="false" k-modal="true" k-draggable="false" k-resizable="false">
            <div class="form-horizontal form-widgets">
                <form name="kForm" class="k-content">
                <div id="rs-emailList"></div>
                <div ng-cloak ng-bind="userAccountMessage"></div>
                <div class="buttons-wrap">
                    <button class="k-button k-primary k-state-default" ng-click="createUserAccount()">{{userAccountButtonText}}</button>
                </div>
                </form>
            </div>
        </div>
        <div kendo-window="resendEmailWindow" id="resendEmailWindow" k-title="'Resend Activation Email'" k-width="400" k-height="226" k-visible="false" k-modal="true" k-draggable="false" k-resizable="false">
            <div class="form-horizontal form-widgets">
                <form name="kForm" class="k-content">
                <div ng-cloak ng-bind="resendEmailAddress"></div>
                <div ng-cloak ng-bind="resendEmailMessage"></div>
                <div class="buttons-wrap">
                    <button class="k-button k-primary k-state-default" ng-click="resendEmail()">{{resendEmailButtonText}}</button>
                </div>
                </form>
            </div>
        </div>
        <div kendo-window="confirmDeleteWindow" id="confirmDeleteWindow" k-title="'Delete Account'" k-width="400" k-height="226" k-visible="false" k-modal="true" k-draggable="false" k-resizable="false">
            <div class="form-horizontal form-widgets">
                <form name="kForm" class="k-content">
                Are you sure you want to delete
                <div ng-cloak ng-bind="removeAccountEmail"></div>
                <div ng-cloak ng-bind="removeAccountMessage"></div>
                <div class="buttons-wrap">
                    <button class="k-button k-primary k-state-default" ng-click="removeAccount()">Confirm</button>
                </div>
                </form>
            </div>
        </div>
        <div class="ng-cloak profile profile-popup" kendo-window="resetPasswordWindow" id="resetPasswordWindow" k-title="'Change Password'" k-width="368" k-height="360" k-visible="false" k-modal="true" k-draggable="false" k-resizable="false">
            <div class="form-horizontal form-widgets">
                <form name="kForm" kendo-validator="pwdValidator" k-options="validOptions" ng-submit="validate($event, true)" class="k-content down-err-txt" ng-model="isPwdValid">
                <div class="form-group">
                    <label class="control-label" for="current_password">Current Password</label>
                    <div class="col-sm-12">
                        <input type="password" id="current_password" name="Current Password" ng-model="resetPwdUser.current_password" class="k-textbox normal-tb popup-input" placeholder="Set Your Password" required data-required-msg="required field" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label" for="password">New Password</label>
                    <div class="col-sm-12">
                        <input type="password" id="new_password" name="New Password" ng-model="resetPwdUser.password" class="k-textbox normal-tb popup-input" placeholder="Set Your Password" required data-required-msg="required field" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="control-label" for="confirm_password">Confirm Password</label>
                    <div class="col-sm-12">
                        <input type="password" id="confirm_password" name="Confirm Password" class="k-textbox normal-tb popup-input" placeholder="Retype Your Password" required data-required-msg="required field" ng-model="resetPwdUser.confirm_password"/>
                    </div>
                </div>
                <div class="buttons-wrap">
                    <button class="k-button normal-btn" type="submit" ng-disabled="!isPwdValid">Save</button>
                </div>
                </form>
            </div>
        </div>
        <button class='k-button normal-btn sharedAcc' ng-click="showCreateSharedAccountWindow()">Create Shared Account</button>
        <kendo-grid options="secGridOptions">
        </kendo-grid>
        <div kendo-window="createSharedAccountWindow" id="createSharedAccountWindow" k-title="'Create Account'" k-width="400" k-height="226" k-visible="false" k-modal="true" k-draggable="false" k-resizable="false">
            <div class="form-horizontal form-widgets">
                <form name="kForm" kendo-validator="validator" ng-submit="validate($event)" class="k-content">
                <div class="form-group">
                    <label class="control-label" for="username">Username:</label>
                    <input type="username" id="username" name="Username" ng-model="user.username" class="k-textbox normal-tb" placeholder="Username" required data-required-msg="required field" />
                </div>
                <div class="form-group">
                    <label class="control-label" for="password">Password:</label>
                    <input type="password" id="password" name="Password" ng-model="user.password" class="k-textbox normal-tb" placeholder="Password" required data-required-msg="required field" />
                </div>
                <div class="form-group">
                    <label class="control-label" for="confirm_password">Confirm Password:</label>
                    <input type="password" id="confirm_password" name="Confirm Password" class="k-textbox normal-tb" placeholder="Retype Password" required data-required-msg="required field" />
                </div>
                <div class="buttons-wrap">
                    <button class="k-button k-primary k-state-default" ng-click="createSharedAccount()">{{sharedAccountButtonText}}</button>
                </div>
                <div ng-bind="sharedAccountMessage"></div>
                </form>
            </div>
        </div>
    </div>
</div>

<script id="rowTemplate" type="text/x-kendo-tmpl">
    # if (is_email_verified == true) { #
    <tr data-uid="#: uid #">
        <td> ${fullname} </td>
        <td> ${email} </td>
        <td> ${department} </td>
        <td> ${language} </td>
        <td> <button class='k-button' ng-click='confirmDeleteAccount(dataItem)'>Delete</button> </td>
    </tr>
    # } else { #
    <tr data-uid="#: uid #">
        <td> Account Not Activated </td>
        <td> ${email} </td>
        <td colspan='2'> <button class='k-button' ng-click='resendEmail(dataItem)'>Resend Activation Email</button> </td>
        <td> <button class='k-button' ng-click='confirmDeleteAccount(dataItem)'>Delete</button> </td>
    </tr>
    # } #
</script>
{% endverbatim %}

<script>
    angular.module("Entrak", [ "kendo.directives" ])
        .controller("myCtrl", function($scope, $http){

            var etDropDown = new EtDropDown($("#rs-emailList"), ['hotdogxz@gmail.com', 'hotdogxz@hotmail.com']);

            var individual_users = new kendo.data.DataSource({
                batch: true,
                transport: {
                    read: {
                        async: true,
                        url: "{% url 'companies.users' system.code %}",
                        type: 'GET',
                        dataType: "json"
                    },
                    create: {
                        url: "{% url 'users.create_individual_users' %}",
                        type: "POST",
                        contentType: "application/json"
                    },
                    parameterMap: function (options, operation) {
                        if (operation == "create") {
                            return kendo.stringify(options);
                        }
                    }
                },
                schema: {
                    data: function (data) {
                        return data;
                    },
                    total: function (data) {
                        return data['odata.count'];
                    },
                    model: {
                        fields: {
                            id: { type: "number" },
                            fullname: { type: "string" },
                            department: { type: "string" },
                            language: { type: "string" },
                            email: { type: "string" },
                            is_email_verified: { type: "boolean" },
                            is_personal_account: { type: "boolean" }
                        }
                    }
                },
                filter: {field: "is_personal_account", operator: "eq", value: true }
            });

            var shared_users = new kendo.data.DataSource({
                batch: true,
                transport: {
                    read: {
                        async: true,
                        url: "{% url 'companies.users' system.code %}",
                        type: 'GET',
                        dataType: "json"
                    },
                    create: {
                        url: "{% url 'users.create_shared_user' %}",
                        type: "POST",
                        contentType: "application/json"
                    },
                    parameterMap: function (options, operation) {
                        if (operation == "create") {
                            return kendo.stringify(options);
                        }
                    }
                },
                schema: {
                    data: function (data) {
                        return data;
                    },
                    total: function (data) {
                        return data['odata.count'];
                    },
                    model: {
                        id: "id",
                        fields: {
                            id: { type: "number" },
                            username: { type: "string" },
                            is_email_verified: { type: "boolean" },
                            is_personal_account: { type: "boolean" }
                        }
                    }
                },
                filter: {field: "is_personal_account", operator: "eq", value: false }
            });

            $scope.userAccountMessage = null;
            $scope.sharedAccountMessage = null;

            $scope.priGridOptions = {
                dataSource: individual_users,
                sortable: true,
                columns: [
                    { field: "fullname", title: "Full Name", width: "200px" },
                    { field: "email", title: "Email", width: "80px" },
                    { field: "department", title: "Department", width: "80px" },
                    { field: "language", title: "Language", width: "80px" },
                    { title: "Delete", width: "60px" }
                ],
                rowTemplate: kendo.template($("#rowTemplate").html()),
            }

            $scope.secGridOptions = {
                dataSource: shared_users,
                sortable: true,
                columns: [
                    { field: "username", title: "User Name", width: "400px" },
                    { title: "Password", width: "100px", template: "<button class='k-button' ng-click='showResetPasswordWindow()'>Change password</button>"},
                    { title: "Action", width: "60px", template: "<button class='k-button' ng-click='confirmDeleteAccount(dataItem)'>Delete</button>" }
                ],
            }

            $scope.userAccountMessage = "";
            $scope.userAccountButtonText = "Send";
            $scope.isEmailSent = false;

            $scope.resendEmailButtonText = "Send";
            $scope.isEmailResent = false;

            $scope.sharedAccountButtonText = "Create"
            $scope.isAccountCreated = false;

            $scope.showCreateUserAccountWindow = function() {
                $scope.isEmailSent = false;
                $scope.userAccountMessage == "";
                $scope.userAccountButtonText = "Send";
                $("#createUserAccountWindow").data("kendoWindow").center().open();
            }

            $scope.showCreateSharedAccountWindow = function() {
                $scope.isAccountCreated = false;
                $scope.sharedAccountMessage == "";
                $scope.sharedAccountButtonText = "Create";
                $("#createSharedAccountWindow").data("kendoWindow").center().open();
            }

            $scope.createUserAccount = function() {
                if (!$scope.isEmailSent) {
                    emails = etDropDown.value();
                    system_id = {{system.id}};
                    for (i = 0; i < emails.length; i++) {
                        individual_users.add(
                        {
                            email: emails[i],
                            system_id: system_id,
                            is_email_verified: false,
                            is_personal_account: true
                        });
                    }

                    individual_users.sync()
                        .done(function() {
                            $scope.isEmailSent = true;
                            $scope.userAccountMessage = "Great, the invitation has been sent out.";
                            $scope.userAccountButtonText = "Go to Dashboard";
                        })
                        .fail(function(e) {
                            console.log(e)
                            $scope.userAccountMessage = e.responseText;
                        });
                    individual_users.read();


                } else {
                    console.log("Redirecting to Dashboard");
                    window.location.href = "{% url 'companies.dashboard' system.code %}"
                }

                return false;
            }

            $scope.createSharedAccount = function() {
                if (!$scope.isAccountCreated) {
                    system_id = {{system.id}};
                    shared_users.add({
                        username: $('#username')[0].value,
                        system_id: system_id,
                        password: $('#password')[0].value
                    });

                    shared_users.sync()
                        .done(function() {
                            $scope.isAccountCreated = true;
                            $scope.sharedAccountMessage = "Great you just created a shared account";
                            $scope.sharedAccountButtonText = "Close";
                        })
                        .fail(function(e) {
                            console.log(e)
                            $scope.sharedAccountMessage = e.responseText;
                        });
                    shared_users.read();

                } else {
                    $scope.isAccountCreated = true;
                    console.log("Shared account created");
                }

                return false;
            }


            $scope.resendEmail = function() {
                if (!$scope.isEmailResent) {
                    url = "{% url 'users.send_invitation_email' user.id %}"
                    console.log("Resending Activation Email");
                    $http({
                        method : 'GET',
                        url : url.replace('{{user.id}}', $scope.resendEmailId),
                        contentType: 'application/html; charset=utf-8',
                        data: $scope.resendEmailAddress,
                    }).success(function(data) {
                        $scope.isEmailResent = true;
                        $scope.resendEmailMessage = "The invitation has been sent out.";
                        $scope.resendEmailButtonText = "Close";
                    }).error(function(data) {
                        console.log(data);
                    })
                } else {
                    $scope.isEmailResent = false;
                    $scope.resendEmailMessage = "";
                    $("#resendEmailWindow").data("kendoWindow").close();
                }

                return false;
            }

            $scope.resendEmail = function(dataItem) {
                $scope.resendEmailId = dataItem.id;
                $scope.resendEmailAddress = dataItem.email;
                $scope.resendEmailButtonText = "Send";
                $scope.resendEmailMessage = "";
                $("#resendEmailWindow").data("kendoWindow").center().open();
            }

            $scope.confirmDeleteAccount = function(dataItem) {
                $scope.removeAccountId = dataItem.id;
                $scope.removeAccountEmail = dataItem.email;
                $scope.removeAccountMessage = "";
                $("#confirmDeleteWindow").data("kendoWindow").center().open();
            }

            $scope.removeAccount = function() {
                url = "{% url 'users.send_invitation_email' user.id %}"
                    console.log("Resending Activation Email");
                    $http({
                        method : 'GET',
                        url : url.replace('{{user.id}}', $scope.removeAccountId),
                        contentType: 'application/html; charset=utf-8',
                        data: $scope.resendEmailAddress,
                    }).success(function(data) {
                        $scope.isEmailResent = true;
                        $scope.resendEmailMessage = "The invitation has been sent out.";
                        $scope.resendEmailButtonText = "Close";
                    }).error(function(data) {
                        console.log(data);
                    })
                console.log("DELETED");
                return false;
            }

            $scope.showResetPasswordWindow = function() {
                $("#resetPasswordWindow").data("kendoWindow").center().open();
            }
        })
</script>
{% endblock %}
