{% extends "page_base.html" %}

{% load entrak_extras %}
{% load static %}
{% load humanize %}

{% block extra_head %}
{{block.super}}

<link rel="stylesheet" type="text/css" href="{% static 'css/drop-down-panel.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/report.css' %}">
<script src="{% static 'js/jquery-cookie-master/jquery.cookie.js' %}"></script>
<script src="{% static 'js/csrf_ajax.js' %}"></script>
<script src="{% static 'js/moment-timezone-with-data.min.js' %}"></script>
<script src="{% static 'js/mustache.js-master/mustache.js' %}"></script>
<script src="{% static 'js/jquery.tinysort.min.js' %}"></script>
<script src="{% static 'js/flot/jquery.flot.min.js' %}"></script>
<script src="{% static 'js/flot/jquery.flot.pie.min.js' %}"></script>
<script src="{% static 'js/entrak-system.js' %}"></script>
<script src="{% static 'js/entrak-utils.js' %}"></script>
<script src="{% static 'js/report-generator.js' %}"></script>
{% endblock %}

{% block selected-menu-link-id %}menu-link-report{% endblock %}
{% block system_menu_target_view %}report{% endblock %}
{% block breadcrumb_target_view %}report{% endblock %}

{% block page_title %}THE REPORTS PAGE{% endblock %}
{% block page_subtitle %}Get all your information here at the{% endblock %}

{% block extra_script %}
{{block.super}}

{% include "report_inner_template.html" %}

<script type="text/javascript">

var report = {};

function updateReportName() {
	$(".report-name").text(report.reportGenerator.genReportName());
}

function updateBoundDt() {
	if (report.currentReportType === ReportGenerator.REPORT_TYPE_YEAR) {
		if (report.firstRecord.month() === 0 && report.firstRecord.date() === 1) {
			report.boundStartDt = moment(report.firstRecord).startOf('year');
		} else {
			report.boundStartDt = moment(report.firstRecord).add('y', 1).startOf('year');
		}

		report.boundEndDt = moment().tz(report.timezone).startOf('year');
	} else if (report.currentReportType === ReportGenerator.REPORT_TYPE_QUARTER) {
		if (report.firstRecord.date() === 1
			&& (report.firstRecord.month() === 0 || report.firstRecord.month() === 3
				|| report.firstRecord.month() === 6 || report.firstRecord.month() === 9)) {
			report.boundStartDt = moment(report.firstRecord).startOf('quarter');
		} else {
			report.boundStartDt = moment(report.firstRecord).add('M', 3).startOf('quarter');
		}

		report.boundEndDt = moment().tz(report.timezone).startOf('quarter');
	}
}

function isTargetDtValid(targetDt) {
	return ( (targetDt.isAfter(report.boundStartDt) || targetDt.isSame(report.boundStartDt))
		&& targetDt.isBefore(report.boundEndDt));
}

function updateReportType(targetReportType) {
	report.currentReportType = targetReportType;
	updateBoundDt();

	if (targetReportType === ReportGenerator.REPORT_TYPE_YEAR) {
		timeRangeYearSelected();
	} else if (targetReportType === ReportGenerator.REPORT_TYPE_QUARTER) {
		timeRangeQuarterSelected();
	}

	updateGenReportSection();
}

function timeRangeYearSelected() {
	report.currentDt = moment(report.boundEndDt).subtract('y', 1);

	var targetYearEle = $(".year-quarter-calendar-head .target-year");
	targetYearEle.text(report.currentDt.format('YYYY'));

	$(".year-quarter-calendar-head .prev-btn").off('click').click(function() {
		var targetDt = moment(report.currentDt).subtract('y', 1);
		if (isTargetDtValid(targetDt)) {
			report.currentDt.subtract('y', 1);
			targetYearEle.text(report.currentDt.format('YYYY'));
			updateGenReportSection();
		}
	});
	$(".year-quarter-calendar-head .next-btn").off('click').click(function() {
		var targetDt = moment(report.currentDt).add('y', 1);
		if (isTargetDtValid(targetDt)) {
			report.currentDt.add('y', 1);
			targetYearEle.text(report.currentDt.format('YYYY'));
			updateGenReportSection();
		}
	});
}

function updateSelectedQuarter() {
	$(".year-quarter-calendar-content>div").removeClass('selected-quarter');
	var quarterIdx = report.currentDt.month()/3;
	$($(".year-quarter-calendar-content>div")[quarterIdx]).addClass('selected-quarter');
}

function timeRangeQuarterSelected() {
	report.currentDt = moment(report.boundEndDt).subtract('M', 3);

	var targetYearEle = $(".year-quarter-calendar-head .target-year");
	targetYearEle.text(report.currentDt.format('YYYY'));
	updateSelectedQuarter();

	$(".year-quarter-calendar-head .prev-btn").off('click').click(function() {
		var targetDt = moment(report.currentDt).subtract('y', 1);
		if (targetDt.year() >= report.boundStartDt.year()) {
			report.currentDt.subtract('y', 1);
			while(report.currentDt.isBefore(report.boundStartDt)) {
				report.currentDt.add('M', 3);
			}
			targetYearEle.text(report.currentDt.format('YYYY'));
			updateSelectedQuarter();
			updateGenReportSection();
		}
	});
	$(".year-quarter-calendar-head .next-btn").off('click').click(function() {
		var targetDt = moment(report.currentDt).add('y', 1);
		if (targetDt.year() < report.boundEndDt.year()
			|| (targetDt.year() === report.boundEndDt.year() && report.boundEndDt.month() !== 0) ) {
			report.currentDt.add('y', 1);
			while(!(report.currentDt.isBefore(report.boundEndDt))) {
				report.currentDt.subtract('M', 3);
			}
			targetYearEle.text(report.currentDt.format('YYYY'));
			updateSelectedQuarter();
			updateGenReportSection();
		}
	});
}

function updateGenReportSection() {
	var fromText, toText;
	if (report.currentReportType === ReportGenerator.REPORT_TYPE_YEAR) {
		fromText = report.currentDt.format('YYYY');
		toText = report.reportGenerator.genEndDt(report.currentDt, report.currentReportType).format('YYYY');
	} else if (report.currentReportType === ReportGenerator.REPORT_TYPE_QUARTER) {
		fromText = report.currentDt.format('YYYY MMMM');
		toText = report.reportGenerator.genEndDt(report.currentDt, report.currentReportType).format('YYYY MMMM');
	}
	$(".datetime-result .from-date").text(fromText);
	$(".datetime-result .to-date").text(toText);
}

$(function() {
	setupAjaxForCsrf($.cookie('csrftoken'));

	report.entrakSystem = new EntrakSystem();
	report.entrakSystem.assignSystemTree('{{systems|jsonifySystems}}');

	report.currentReportType = ReportGenerator.REPORT_TYPE_MONTH;
	report.timezone = '{{systems.0.timezone}}';
	report.firstRecord = moment.unix(report.entrakSystem.systemTree.data.firstRecord).tz(report.timezone);
	{% if monthly_summary|length >= 1 %}
	report.currentDt =  moment.unix({{monthly_summary.0.timestamp}}).tz(report.timezone);
	{% endif %}

	$(".report-component").css("opacity", 0.0);

	report.reportGenerator = new ReportGenerator(report.entrakSystem.systemTree, report.timezone,
		ReportGenerator.REPORT_TYPE_MONTH);
	if ("currentDt" in report) {
		report.reportGenerator.updateDtInfo(report.currentDt, null);
		updateReportName();

		report.reportGenerator.getReportData(function(data) {
			report.reportGenerator.assignData(data);
			report.reportGenerator.generateFullReport();
			$(".report-component").fadeTo(600, 1.0);
		});
	}

	$(".panel-header-left-menu h3").each(function(btnIdx) {
		$(this).click(function() {
			$(".panel-header-left-menu h3").removeClass('selected-tab');
			$(this).addClass('selected-tab');

			if (btnIdx === 0) {
				$("#panel-content").css('height', '162px');
			} else if (btnIdx === 1) {
				$("#panel-content").css('height', '378px');
				updateReportType(ReportGenerator.REPORT_TYPE_YEAR);
			}

			var targetPanel = $($('#panel-content>div')[btnIdx]);
			if (targetPanel.css("display") == 'none') {
				$('#panel-content>div').fadeOut();
				targetPanel.fadeIn();
			}
		});
	});
	$(".panel-header-left-menu h3:eq(1)").click();

	$(".time-range-section span").each(function(btnIdx) {
		$(this).click(function() {
			var targetReportType;
			if (btnIdx === 0) {
				targetReportType = ReportGenerator.REPORT_TYPE_YEAR;
			} else if(btnIdx === 1) {
				targetReportType = ReportGenerator.REPORT_TYPE_QUARTER;
			}

			if (targetReportType !== report.currentReportType) {
				updateReportType(targetReportType);
			}
		});
	});

	$(".summary-date-col").click(function() {
		$(".report-component").fadeTo(600, 0.0);
		var targetDt = moment.unix(parseInt($(this).attr("dt_timestamp")));
		report.currentDt = targetDt;
		report.reportGenerator.updateDtInfo(report.currentDt, null);
		report.reportGenerator.getReportData(function(data) {
			report.reportGenerator.assignData(data);
			report.reportGenerator.generateFullReport();
			$(".report-component").fadeTo(600, 1.0);
		});
		updateReportName();
	});

	$(".hide-details-btn").click(function() {
		$(this).toggleClass('btn-down');
		$(this).parent().parent().find(".detail-container").slideToggle();
	})

	$(".save-report-btn, .bottom-save-report-btn").click(function() {
		$(".download-pdf-form input[name='start_timestamp']").attr("value", report.currentDt.unix());
		$(".download-pdf-form input[name='report_type']").attr("value", report.currentReportType);
		$(".download-pdf-form").submit();
	});

	$(".create-report-btn").click(function() {
		report.reportGenerator.reportType = report.currentReportType;
		report.reportGenerator.updateDtInfo(report.currentDt, null);

		$(".report-component").fadeTo(600, 0.0);
		updateReportName();
		report.reportGenerator.getReportData(function(data) {
			report.reportGenerator.assignData(data);
			report.reportGenerator.generateFullReport();
			$(".report-component").fadeTo(600, 1.0);
		});
	});

	$(".year-quarter-calendar-content>div").each(function(btnIdx) {
		$(this).click(function() {
			var targetDt = moment(report.currentDt).month(btnIdx*3);
			if (isTargetDtValid(targetDt)) {
				$(".year-quarter-calendar-content>div").removeClass('selected-quarter');
				$(this).addClass('selected-quarter');
				report.currentDt = targetDt;
				updateGenReportSection();
			}
		});
	});
});
</script>

{% endblock %}

{% block page_content %}

<div class="panel-component">
	<div class="drop-down-panel-header">
		<div class="panel-header-left-menu">
			<h3 panel="monthly-report">
				Monthly Report</h3><h3 panel="customize-report">
				Customize Report</h3><h3 panel="download-data">Download Data</h3>
		</div>
	</div>

	<div id="panel-content">
		<div id="monthly-report">
			<div id="monthly-report-header">
				<span>Monthly Reports</span>
				<span>Energy Consumption (kWh)</span>
				<span>CO<sub>2</sub> Emissions (kg)</span>
				<span>Energy Cost ($)</span>
				<span>Download</span>
			</div>
			<hr>
			<hr>
			<div id="monthly-report-content">
				{% for summary in monthly_summary %}
				<div>
					<span class="summary-date-col" dt_timestamp="{{summary.timestamp}}">{{summary.dt|date:"M Y"}}</span>
					<span>{{summary.energy_usage|floatformat:"0"|intcomma}}</span>
					<span>{{summary.co2_usage|floatformat:"0"|intcomma}}</span>
					<span>{{summary.money_usage|floatformat:"0"|intcomma}}</span>
				</div>
				{% endfor %}
			</div>
		</div>

		<div id="customize-report">
			<div class="customize-section-title"><span>1</span>Select your time range</div>
			<div class="time-range-section">
				<span></span>
				<span></span>
				<span></span>
				<span></span>
			</div>
			<div class="customize-detail-section">
				<div class="two-column-section">
					<div>
						<div class="customize-section-title"><span>2</span>Select your time period</div>
						<div class="customize-calendar-section">
							<div class="year-quarter-calendar">
								<div class="year-quarter-calendar-head">
									<span class="prev-btn">◀</span><span class="target-year"></span><span class="next-btn">▶</span>
								</div>
								<div class="year-quarter-calendar-content">
									<div>
										<div>Q1</div>
										<div><span>Jan</span><span>Feb</span><span>Mar</span></div>
									</div>
									<div>
										<div>Q2</div>
										<div><span>Apr</span><span>May</span><span>Jun</span></div>
									</div>
									<div>
										<div>Q3</div>
										<div><span>Jul</span><span>Aug</span><span>Sep</span></div>
									</div>
									<div>
										<div>Q4</div>
										<div><span>Oct</span><span>Nov</span><span>Dec</span></div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div>
						<div class="customize-section-title"><span>3</span>Create your report</div>
						<div class="create-report-section">
							<div class="datetime-result">
								<div>Energy data - kWh</div>
								<hr>
								<div>
									<div><span>From:</span><span class="from-date"></span></div>
									<div><span>To:</span><span class="to-date"></span></div>
								</div>
								<hr>
								<div class="create-report-btn">Create Report</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<div class="report-head">
	<div class="system-name">{{systems.0.name}}</div>
	<hr class="title-separator">
	<div class="report-name"></div>
	<div class="save-report-btn">Save Report</div>
	<hr class="head-separator">
</div>

{% include "report_main_content.html" %}

<div class="bottom-save-report-btn">Save Report</div>
<div class="bottom-space"></div>

<form class="download-pdf-form" action="{% url 'report_pdf' system_code=systems.0.code %}" method="POST">{% csrf_token %}
	<input name="start_timestamp" value="">
	<input name="report_type" value="">
</form>

{% endblock %}
