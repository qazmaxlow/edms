{% extends "page_base.html" %}

{% load entrak_extras %}
{% load static %}
{% load humanize %}

{% block extra_head %}
{{block.super}}

<link rel="stylesheet" type="text/css" href="{% static 'css/drop-down-panel.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/report.css' %}">
<script src="{% static 'js/jquery-cookie-master/jquery.cookie.js' %}"></script>
<script src="{% static 'js/csrf_ajax.js' %}"></script>
<script src="{% static 'js/moment-timezone-with-data.min.js' %}"></script>
<script src="{% static 'js/mustache.js-master/mustache.js' %}"></script>
<script src="{% static 'js/jquery.tinysort.min.js' %}"></script>
<script src="{% static 'js/flot/jquery.flot.min.js' %}"></script>
<script src="{% static 'js/flot/jquery.flot.pie.min.js' %}"></script>
<script src="{% static 'js/entrak-system.js' %}"></script>
<script src="{% static 'js/entrak-utils.js' %}"></script>
<script src="{% static 'js/report-generator.js' %}"></script>
{% endblock %}

{% block selected-menu-link-id %}menu-link-report{% endblock %}
{% block system_menu_target_view %}report{% endblock %}
{% block breadcrumb_target_view %}report{% endblock %}

{% block page_title %}THE REPORTS PAGE{% endblock %}
{% block page_subtitle %}Get all your information here at the{% endblock %}

{% block extra_script %}
{{block.super}}

{% include "report_inner_template.html" %}

<script type="text/javascript">

var report = {};

function genReportName(targetDt) {
	var reportName = "";
	if (report.currentReportType === ReportGenerator.REPORT_TYPE_MONTH) {
		reportName = targetDt.format("MMM YYYY");
	}

	return reportName;
}

function updateReportName() {
	var reportName = genReportName(report.currentDt);
	$(".report-name").text(reportName + " - Monthly Energy Report");
}

$(function() {
	setupAjaxForCsrf($.cookie('csrftoken'));

	report.entrakSystem = new EntrakSystem();
	report.entrakSystem.assignSystemTree('{{systems|jsonifySystems}}');

	report.currentReportType = ReportGenerator.REPORT_TYPE_MONTH;
	report.timezone = '{{systems.0.timezone}}';
	{% if monthly_summary|length >= 1 %}
	report.currentDt =  moment.unix({{monthly_summary.0.timestamp}}).tz(report.timezone);
	{% endif %}

	updateReportName();
	$(".report-component").css("opacity", 0.0);

	report.reportGenerator = new ReportGenerator(report.entrakSystem.systemTree, report.timezone,
		ReportGenerator.REPORT_TYPE_MONTH);
	if ("currentDt" in report) {
		report.reportGenerator.getReportData(report.currentDt, function(data) {
			report.reportGenerator.assignData(data);
			report.reportGenerator.generateFullReport();
			$(".report-component").fadeTo(600, 1.0);
		});
	}

	$(".summary-date-col").click(function() {
		$(".report-component").fadeTo(600, 0.0);
		var targetDt = moment.unix(parseInt($(this).attr("dt_timestamp")));
		report.currentDt = targetDt;
		report.reportGenerator.getReportData(report.currentDt, function(data) {
			report.reportGenerator.assignData(data);
			report.reportGenerator.generateFullReport();
			$(".report-component").fadeTo(600, 1.0);
		});
		updateReportName();
	});

	$(".hide-details-btn").click(function() {
		$(this).toggleClass('btn-down');
		$(this).parent().parent().find(".detail-container").slideToggle();
	})

	$(".save-report-btn, .bottom-save-report-btn").click(function() {
		$(".download-pdf-form input[name='start_timestamp']").attr("value", report.currentDt.unix());
		$(".download-pdf-form input[name='report_type']").attr("value", report.currentReportType);
		$(".download-pdf-form").submit();
	});
});
</script>

{% endblock %}

{% block page_content %}

<div class="panel-component">
	<div class="drop-down-panel-header">
		<div class="panel-header-left-menu">
			<h3>Monthly Report</h3><h3>Customize Report</h3><h3>Download Data</h3>
		</div>
	</div>

	<div id="panel-content">
		<div id="monthly-report">
			<div id="monthly-report-header">
				<span>Monthly Reports</span>
				<span>Energy Consumption (kWh)</span>
				<span>CO<sub>2</sub> Emissions (kg)</span>
				<span>Energy Cost ($)</span>
				<span>Download</span>
			</div>
			<hr>
			<hr>
			<div id="monthly-report-content">
				{% for summary in monthly_summary %}
				<div>
					<span class="summary-date-col" dt_timestamp="{{summary.timestamp}}">{{summary.dt|date:"M Y"}}</span>
					<span>{{summary.energy_usage|floatformat:"0"|intcomma}}</span>
					<span>{{summary.co2_usage|floatformat:"0"|intcomma}}</span>
					<span>{{summary.money_usage|floatformat:"0"|intcomma}}</span>
				</div>
				{% endfor %}
			</div>
		</div>
	</div>
</div>

<div class="report-head">
	<div class="system-name">{{systems.0.name}}</div>
	<hr class="title-separator">
	<div class="report-name"></div>
	<div class="save-report-btn">Save Report</div>
	<hr class="head-separator">
</div>

{% include "report_main_content.html" %}

<div class="bottom-save-report-btn">Save Report</div>
<div class="bottom-space"></div>

<form class="download-pdf-form" action="{% url 'report_pdf' system_code=systems.0.code %}" method="POST">{% csrf_token %}
	<input name="start_timestamp" value="">
	<input name="report_type" value="">
</form>

{% endblock %}
