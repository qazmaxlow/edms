{% load i18n %}
// could have better way?
var langCode = '{{LANGUAGE_CODE}}';
kendo.culture(langCode.substring(0,3)+langCode.substring(3,5).toUpperCase());

var ngapp = angular.module("Entrak", [ "kendo.directives" ]);
var report_type = "{{ report_type }}";


ngapp.controller("MyCtrl", function($scope) {
    $scope.onSelect = function(ev) {
        var anchor = $(ev.item).data('anchor');
        location.href = "#"+anchor;
    };
});

function set_serie_date(s) {
    $.each(s, function(idx, elem) {
        elem.datetime = kendo.parseDate(elem.datetime);
    });
}


ngapp.controller("ReportController", function($scope) {
    var date_offset = null;

    function shift_series_date(elem) {
        if (report_type == "month") {
            if (date_offset == null){
                var lastDay = elem.datetime.getDay();
                var diff = new Date(elem.datetime.getFullYear(), elem.datetime.getMonth()+1, 0).getDate();
                elem.datetime.setMonth(elem.datetime.getMonth()+1);
                var curDay = elem.datetime.getDay();
                elem.datetime.setDate(elem.datetime.getDate() + lastDay - curDay);
                date_offset = diff + lastDay - curDay;
            } else {
                elem.datetime.setDate(elem.datetime.getDate() + date_offset);
            }   
        }
        else if (report_type == "week") {
            elem.datetime.setDate(elem.datetime.getDate()+7);
        }
        else if (report_type == "quarter") {
            elem.datetime.setMonth(elem.datetime.getMonth()+3);
        }
        else if (report_type == "year") {
            elem.datetime.setYear(elem.datetime.getFullYear()+1);
        }
        else if (report_type == "custom") {
            var diff = {{ report_day_diff }};
            if (date_offset == null){
                var lastDay = elem.datetime.getDay();
                elem.datetime.setDate(elem.datetime.getDate() + diff);
                var curDay = elem.datetime.getDay();
                elem.datetime.setDate(elem.datetime.getDate() + lastDay - curDay);
                date_offset = diff + lastDay - curDay;
            } else {
                elem.datetime.setDate(elem.datetime.getDate() + date_offset);
            }            
        }
    }

    var cg_ds = {};
    // compare graph datasources... should use APIs
    {% for cg in sub_compare_graphs  %}
    cg_ds[{{ forloop.counter }}] = {
        last: {{cg.last_reading_serie|safe}},
        current: {{cg.current_reading_serie|safe}},
    };
    {% endfor %}

    $.each(cg_ds, function(idx, ds) {
        set_serie_date(ds.current);
        set_serie_date(ds.last);
        $.each(ds.last, function(idx, elem) {shift_series_date(elem)});
    });
    $scope.cgDatas = cg_ds;


    $scope.transformedPieOptions = {
        legend: {
            visible: false
        },
        seriesDefaults: {
            type: "donut",
            labels: {
                template: "#= kendo.format('{0:p0}', percentage)#",
                position: "Center",
                distance: 20,
                visible: true,
                background: "transparent",
                font: "bold 14px Arial",
                color: function(e) {
                    return e.dataItem.color;
                },
                border: {
                    width: 0,
                    color: "white"
                }
            },
            overlay: {
                gradient: "none"
            }
        },
        plotArea: {
            margin: 10
        },
        chartArea: {
            height: 250,
            width: 300
        },
        series: [{
            startAngle: 150,
            data: {{ transformed_pie_json|safe }}
        }],
        tooltip: {
            visible: true,
            format: "{0}%",
            template: "#= category #: #= kendo.format('{0:n0}',value) #"
        }

    };

    var bar_date_format = '{0:MMM}';
    var bar_datetime_type = 'date';

    if (report_type == 'week') {
        bar_date_format = '{0:M}';
        bar_datetime_type = 'string';
    }
    else if (report_type == 'year') {
        bar_date_format = '{0:yyyy}';
    }
    else if (report_type == 'custom') {
        bar_date_format = '{0:M}';
        bar_datetime_type = 'string';
    }

    $scope.barOptions = {
        dataSource: {
            data: {{ compare_past_datasource_json|safe }},
            schema: {
                model: {
                    fields: {
                        datetime: { type: bar_datetime_type}
                    }
                }
            }
        },
        title: {
            text: "{{ barchart_title }}",
            color: "#edbe4a"
        },
        legend: {
            visible: false
        },
        chartArea: {
            background: "",
            margin: {top: 20, bottom: 20}
        },
        seriesDefaults: {
            type: "column",
            labels: {
                visible: true,
                background: "transparent",
                template: "# if ( value > 0) { # #= kendo.toString(value, 'n0') # # } else { # N/A # } #"
            }
        },
        series: [{
            field: "value",
            color: "#eab541",
            border: {
                width: 0
            },
            overlay: {
                gradient: "none"
            }
        }],

        valueAxis: {
            visible: false,
            line: {
                visible: false
            },
            minorGridLines: {
                visible: false
            }
        },
        categoryAxis: {
            type: 'category',
            field: 'datetime',
            labels: {
                format: bar_date_format
            },
            majorTicks: {
                size: 0,
                width: 0
            },
            majorGridLines: {
                visible: false
            }
        },
        tooltip: {
            visible: true,
            template: "#= dataItem.month #: #= kendo.toString(value, 'n0') #"
        }
    };

    var powers = {{ compare_series|safe }};
    var line_step = 2;
    var line_date_formats = { days: 'ddd'};
    if (report_type == 'year' || report_type == 'quarter') {
        line_step = 31;
        line_date_formats = { days: 'MMM'};
    } else if (report_type == 'week'){
        line_step = 1;
    } else if (report_type == 'month'){
        line_step = 3;
    }

    $scope.lineOptions = {
        width: 1000,
        title: {
            text: "{% trans "When did we achieve our savings?" %}",
            color: "#354960",
            font: "bold 1.145em Arial"
        },
        legend: {
            position: "top"
        },
        chartArea: {
            background: "",
            margin: {top: 20, bottom: 20}
        },


        dataSource: {
            data: powers,
            group: [{field: "type", dir: "desc"}],
            schema:{
                parse:function (response) {
                    $.each(response, function (idx, elem) {
                        if (elem.datetime && typeof elem.datetime === "string") {
                            elem.datetime = kendo.parseDate(elem.datetime);
                            if (elem.type == "last") {
                                shift_series_date(elem);
                            }
                        }
                    });
                    return response;
                }
            }
        },


        seriesColors: ["#edba3c", "#047fa1"],
        series: [
            {
                type: "line",
                markers: {
                    visible: false
                },
                // aggregate: "avg",
                name: '# if (group.value == "last") { # {{ compare_last_name }} # } else { # {{ compare_current_name }} # } #',
                color: "#edba3c",
                field: "value",
                categoryField: "datetime"
            }
        ],

        tooltip: {
            visible: true,
            format: "{0:n0} kWh"
        },

        valueAxis: {
            line: {
                visible: false
            },
            title: {
                text: "kWh",
                color: "#9F9F9F",
                font: "0.9em Arial"
            },
            minorGridLines: {
                visible: false
            }
        },
        categoryAxis: {
            baseUnit: "days",
            majorGridLines: {
                visible: false
            },
            majorTicks: {
                step: line_step,
                size: 0,
                width: 0
            },
            labels: {
                step: line_step,
                dateFormats: line_date_formats
            }
        }

    };

    $scope.subLineOptions = {
        legend: {
            position: "top"
        },
        chartArea: {
            background: "",
            margin: {bottom: 20}
        },


        // seriesColors: ["#047fa1", "#edba3c"],
        seriesDefaults:
        {
            type: 'line',
            format: '{0:n0}',
            labels: {
                visible: false
            },
            field: 'value',
            categoryField: 'datetime',
            markers: {
                visible: false
            }
        },

        tooltip: {
            visible: true,
            format: "{0:n0} kWh"
        },

        valueAxis: {
            line: {
                visible: false
            },
            title: {
                text: "kWh",
                color: "#9F9F9F",
                font: "0.9em Arial"
            },
            minorGridLines: {
                visible: false
            }
        },
        categoryAxis: {
            baseUnit: "days",
            majorGridLines: {
                visible: false
            },
            majorTicks: {
                step: line_step,
                size: 0,
                width: 0
            },
            labels: {
                step: line_step,
                dateFormats: line_date_formats
            }
        }

    };
})

setCalendar = function(currentDt, currentEndDt, eleSel, readings, averageUsage, isNotConcernFunc) {
    // var reportGenThis = this;
    var calendarInfoContainer = $(eleSel);
    // calendarInfoContainer.find(".calendar-title").text(this.genDtText(this.currentDt));

    var calendarContainer = calendarInfoContainer.find(".calendar-day-container");
    calendarContainer.empty();

    var calendarStartDt = moment(currentDt).startOf('w');
    var calendarEndDt = moment(currentEndDt).subtract(1, 's').endOf('w');
    var cellCount = 0;
    for (var calendarNowDt=calendarStartDt; calendarNowDt.isBefore(calendarEndDt); calendarNowDt.add(1, 'd')) {
        cellCount++;
        var calendarDayEle = $("<div class='calendar-day'></div>");
        calendarDayEle.append("<div class='calendar-day-digit'>"+calendarNowDt.date()+"</div>");

        if (calendarNowDt.isBefore(currentDt)
            || calendarNowDt.isSame(currentEndDt)
            || calendarNowDt.isAfter(currentEndDt)) {
            calendarDayEle.addClass('calendar-day-out-range');
        } else if (isNotConcernFunc(calendarNowDt)) {
            calendarDayEle.addClass('calendar-day-not-concern');
        } else {
            var diffPercent;
            if (calendarNowDt.unix() in readings) {
                diffPercent = (readings[calendarNowDt.unix()]-averageUsage)/averageUsage*100;
            } else {
                diffPercent = 0;
            }
            diffPercent = parseFloat(Utils.fixedDecBaseOnVal(diffPercent));

            var diffPercentText;
            if (diffPercent >= 0) {
                diffPercentText = "<span class='calendar-day-plus-symbol'>+</span> "+diffPercent;
            } else {
                diffPercentText = "<span class='calendar-day-minus-symbol'>-</span> "+Math.abs(diffPercent);
            }
            if (diffPercent >= 5) {
                calendarDayEle.addClass('calendar-day-worse');
            } else if (diffPercent <= -5) {
                calendarDayEle.addClass('calendar-day-better');
            }
            calendarDayEle.append("<div class='calendar-day-percent'>"
                                  +diffPercentText
                                  +"<span class='calendar-day-percent-symbol'>%</span></div>");
        }
        calendarContainer.append(calendarDayEle);
    }

    var rowCount = cellCount / 7;
    calendarContainer.addClass("calendar-row-" + rowCount);
}


getReportData = function() {
    var report_data;
    var requestData = {
        report_type: 'month',
        start_timestamp: {{ report_start|date:"U" }},
        end_timestamp: {{ report_end|date:"U" }}
    };

    $.ajax({
        type: "POST",
        url: "/{{ company_system.code }}/report_data/",
        data: requestData,
        async: false
    })
        .done(function(data) {
            report_data = data;
        });

    return report_data
}

$(document).ready(function()  {

    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


    // var report_data = getReportData();
    var report_data = {{ report_data_json|safe }};

    var report_readings = {};
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        $.each(info.currentReadings, function(timestamp, readingVal) {
            report_readings[timestamp] = ((timestamp in report_readings) ? report_readings[timestamp] : 0) + readingVal;
        });
    });

    //average uage
    var average_usage = 0;
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        average_usage += info['currentWeekdayInfo'].average;
    });

    var holidays = {{ holidays_json|safe }};

    // for weekday report
    var isNotConcernFunc = null;
    var report_start = new moment("{{ report_start.isoformat }}");
    var report_start = report_start.tz('Asia/Hong_Kong');

    var report_end = new moment("{{ report_end.isoformat }}");
    var report_end = report_end.tz('Asia/Hong_Kong');

    var creport_start = new moment(report_start);
    var creport_end = new moment(report_end);

    var datesInWeek = [];
    if (report_type == 'week') {
        for (var i=0; i<7; i++){
            var tmpDate = new Date(report_start);
            tmpDate.setDate(tmpDate.getDate()+i);

            var dateStr = tmpDate.getFullYear() + "-";
            if (tmpDate.getMonth() > 8){
                dateStr += (tmpDate.getMonth()+1) + "-";
            } else {
                dateStr += "0" + (tmpDate.getMonth()+1) + "-";
            }
            if (tmpDate.getDate() > 9){
                dateStr += tmpDate.getDate();
            } else {
                dateStr += "0" + tmpDate.getDate();
            }
            datesInWeek.push(dateStr);
        }

        creport_start.startOf('month');
        if (report_start.month() == report_end.month())
            creport_end.endOf('month');

        isNotConcernFunc = function(targetDt) {
            return (targetDt.day() == 0
                    || targetDt.day() == 6
                    || ($.inArray(targetDt.format("YYYY-MM-DD"), holidays) != -1)
                    || ($.inArray(targetDt.format("YYYY-MM-DD"), datesInWeek) == -1))
        }
    } else {
        isNotConcernFunc = function(targetDt) {
            return (targetDt.day() == 0
                    || targetDt.day() == 6
                    || ($.inArray(targetDt.format("YYYY-MM-DD"), holidays) != -1))
            // || ($.inArray(targetDt.format("YYYY-MM-DD"), reportGenThis.holidays) != -1))
        }
    }

    setCalendar(
        creport_start, creport_end,
        '#weekday-info .calendar-info-container', report_readings, average_usage, isNotConcernFunc);

    $('#weekday-info .average-usage').html(average_usage);


    var weekend_average_usage = 0;
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        weekend_average_usage += info['currentWeekendInfo'].average;
    });

    if (report_type == 'week') {
        isNotConcernFunc = function(targetDt) {
            return (targetDt.day() >= 1
                    && targetDt.day() <= 5
                    && ($.inArray(targetDt.format("YYYY-MM-DD"), holidays) == -1)
                    || ($.inArray(targetDt.format("YYYY-MM-DD"), datesInWeek) == -1))
        }
    } else {
        isNotConcernFunc = function(targetDt) {
            return (targetDt.day() >= 1
                && targetDt.day() <= 5
                && ($.inArray(targetDt.format("YYYY-MM-DD"), holidays) == -1))
        }
    }

    setCalendar(
        creport_start, creport_end,
        '#weekend-info .calendar-info-container', report_readings, weekend_average_usage, isNotConcernFunc);

    var combinedOvernightCurrentReadings = {};
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        $.each(info.overnightcurrentReadings, function(timestamp, readingVal) {
            combinedOvernightCurrentReadings[timestamp] =
                ((timestamp in combinedOvernightCurrentReadings) ? combinedOvernightCurrentReadings[timestamp] : 0) + readingVal;
        });
    });

    if (report_type == 'week') {
        isNotConcernFunc = function(targetDt) {
            return ($.inArray(targetDt.format("YYYY-MM-DD"), datesInWeek) == -1);
        }
    } else {
        isNotConcernFunc = function(targetDt) {
            return false;
        }
    }

    var overnight_average_usage = 0;
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        overnight_average_usage += info['currentOvernightInfo'].average;
    });

    setCalendar(
        creport_start, creport_end,
        '#overnight-info .calendar-info-container', combinedOvernightCurrentReadings, overnight_average_usage, isNotConcernFunc);

    // $('#weekday-info .average-usage').html(average_usage);

    /*
      var overnight_readings = {};
      $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
      $.each(info.overnightcurrentReadings, function(timestamp, readingVal) {
      overnight_readings[timestamp] =
      ((timestamp in combinedOvernightCurrentReadings) ? overnight_readings[timestamp] : 0) + readingVal;
      });
      });
    */


    // $('#monthly-report-content div').each(function() {
    //     var a = $(this).find('.menu-target:first');
    //     var m = $(this).find('.menu-content:first').kendoContextMenu({
    //         orientation: 'horizontal',
    //         target: a,
    //         showOn: 'click'
    //     });
    // });
});
