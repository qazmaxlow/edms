{% load static %}<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>

    <link rel="stylesheet" type="text/css" href="{% static 'css/drop-down-panel.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'css/popup_report.css' %}">
    <script src="{% static 'js/moment-with-locales.js' %}"></script>
    <script src="{% static 'js/entrak-utils.js' %}"></script>

    <link href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/kendoui/styles/kendo.common.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/kendoui/styles/kendo.default.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/kendoui/styles/kendo.dataviz.min.css' %}" rel="stylesheet">
    <link href="{% static 'assets/kendoui/styles/kendo.dataviz.default.min.css' %}" rel="stylesheet">
    <!-- Because now using jquery v1.11 -->
    <script src="{% static 'assets/kendoui/js/jquery.min.js' %}"></script>
    <script src="{% static 'assets/kendoui/js/angular.min.js' %}"></script>
    <script src="{% static 'assets/kendoui/js/kendo.all.min.js' %}"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="container" ng-app="Entrak">
    <div class="row">
      <div class="col-xs-2">

    <div class="sidebar-left" ng-controller="MyCtrl">
      <div class="section">
              <a class="btn btn-save-report" href="download" role="button">
                <img src="{% static 'images/reports/popup_download.png' %}" alt="logo">
                Save Report</a>
      </div>
      <div class="section">
              <ul kendo-menu style="display: inline-block; min-width: 150px;"
                k-orientation="'vertical'"
                k-on-select="onSelect(kendoEvent)">
              <li data-anchor="report_key_statistics">Key Statistics</li>
              <li data-anchor="report_compared_to_last">Compared to Last Month</li>
              <li data-anchor="weekday-info">Weekdays Energy Use</li>
              <li data-anchor="weekend-info">Weekend and holiday Energy Use</li>
              <li data-anchor="overnight-info">Overnight Energy Use</li>
            </ul>
      </div>
      <img src="{% static 'images/reports/popup_logo.png' %}" alt="logo">
    </div>

      </div>
      <div class="col-xs-10">
        {% include "companies/reports/_report_content.html" %}
      </div>
    </div>
    </div>

    <script>
         var ngapp = angular.module("Entrak", [ "kendo.directives" ]);
      var report_type = "{{ report_type }}";


      ngapp.controller("MyCtrl", function($scope) {
          $scope.onSelect = function(ev) {
              var anchor = $(ev.item).data('anchor');
              location.href = "#"+anchor;
          };
      });

      function set_serie_date(s) {
          $.each(s, function(idx, elem) {
              elem.datetime = kendo.parseDate(elem.datetime);
          });
      }

      function shift_series_date(s) {
          $.each(s, function(idx, elem) {
              if (report_type == "year") {
                  elem.datetime.setYear(elem.datetime.getFullYear()-1);
              }
          });
      }


        ngapp.controller("ReportController", function($scope) {
            $scope.testdata  = [{'name': 'last', 'value': 9.66, 'datetime': new Date('2011/12/30')}, {'name': 'last', 'value': 606.71, 'datetime': new Date('2012/01/01')}];
            var cg_ds = {};
            // compare graph datasources... should use APIs
            {% for cg in sub_compare_graphs  %}
            cg_ds[{{ forloop.counter }}] = {
              last: {{cg.last_reading_serie|safe}},
              current: {{cg.current_reading_serie|safe}},
            };
            {% endfor %}


            $.each(cg_ds, function(idx, ds) {
               set_serie_date(ds.current);
               set_serie_date(ds.last);
               shift_series_date(ds.current);
            });
            $scope.cgDatas = cg_ds;


            $scope.transformedPieOptions = {
                legend: {
                    visible: false
                },
                seriesDefaults: {
                    type: "donut",
                    labels: {
                        template: "#= kendo.format('{0:p0}', percentage)#",
                        position: "Center",
                        visible: true,
                        background: "transparent",
                        font: "bold 18px Arial",
                        color: function(e) {
                            return e.dataItem.color;
                        }
                    },
                    overlay: {
                        gradient: "none"
                    }
                },
                series: [{
                    startAngle: 150,
                    data: {{ transformed_pie_json|safe }}
                }],
                tooltip: {
                    visible: true,
                    format: "{0}%",
                    template: "#= category #: #= kendo.format('{0:n0}',value) #"
                }

            };

            $scope.barOptions = {
        dataSource: {{ compare_past_datasource_json|safe }},
        title: {
            text: "Total energy consumption for the last 6 months (kWh)",
            color: "#edbe4a"
        },
        legend: {
            visible: false
        },
        chartArea: {
            background: ""
        },
        seriesDefaults: {
            type: "column",
            labels: {
                visible: true,
                template: "# if ( value > 0) { # #= kendo.toString(value, 'n0') # # } else { # Nan # } #"
            }
        },
        series: [{
            field: "value",
            color: "#eab541",
            border: {
                width: 0
            },
            overlay: {
                gradient: "none"
            }
        }],

        valueAxis: {
            visible: false,
            line: {
                visible: false
            },
            minorGridLines: {
                visible: false
            }
        },
        categoryAxis: {
            field: "month",
            majorGridLines: {
                visible: false
            }
        },
        tooltip: {
            visible: true,
            format: "{0}%",
            template: "#= dataItem.month #: #= value #"
        }
    };

      var powers = {{ compare_last_readings_series|safe }};

      $scope.lineOptions = {
                width: 1000,
        title: {
            text: "WHEN DID WE ACHIEVE OUR SAVINGS?",
            color: "#354960"
        },
        legend: {
            position: "top"
        },
        chartArea: {
            background: ""
        },


        dataSource: {
            data: powers,
            group: {field: "name"},
            schema:{
                parse:function (response) {
                $.each(response, function (idx, elem) {
                    if (elem.datetime && typeof elem.datetime === "string") {
                        elem.datetime = kendo.parseDate(elem.datetime, "yyyy-MM-ddTHH:mm:ssZ");
                        if (report_type == "year" && elem.name == "current") {
                            elem.datetime.setYear(elem.datetime.getFullYear()-1);
                        }
                    }
                });
                return response;
                }
           }
        },


        seriesColors: ["#047fa1", "#edba3c"],
        series: [
            {
                 type: "line",
                 markers: {
                     visible: false
                 },
                 // aggregate: "avg",
                 name: '{{ compare_last_reading_name }}',
                 color: "#edba3c",
                 field: "value",
                 categoryField: "datetime"
            }
        ],

        tooltip: {
            visible: true,
            format: "{0:n0} kWh"
        },

        valueAxis: {
            line: {
                visible: false
            },
            title: {
                text: "kWh"
            },
            minorGridLines: {
                visible: false
            }
        },
        categoryAxis: {
           baseUnit: "days",
           majorGridLines: {
              visible: false
           },
           majorTicks: {
              step: 30
           },
           labels: {
              step: 30
           }
        }

    };

      $scope.subLineOptions = {
        title: {
            text: "WHEN DID WE ACHIEVE OUR SAVINGS?",
            color: "#354960"
        },
        legend: {
            position: "top"
        },
        chartArea: {
            background: ""
        },


        // seriesColors: ["#047fa1", "#edba3c"],
        seriesDefaults:
            {
                type: 'line',
                format: '{0:n0}',
                labels: {
                    visible: false
                },
                field: 'value',
                categoryField: 'datetime',
                markers: {
                  visible: false
                }
            },

        tooltip: {
            visible: true,
            format: "{0:n0} kWh"
        },

        valueAxis: {
            line: {
                visible: false
            },
            title: {
                text: "kWh"
            },
            minorGridLines: {
                visible: false
            }
        },
        categoryAxis: {
           baseUnit: "days",
           majorGridLines: {
              visible: false
           },
           majorTicks: {
              step: 30
           },
           labels: {
              step: 30
           }
        }

    };
        })

setCalendar = function(currentDt, currentEndDt, eleSel, readings, averageUsage, isNotConcernFunc) {
    // var reportGenThis = this;
    var calendarInfoContainer = $(eleSel);
    // calendarInfoContainer.find(".calendar-title").text(this.genDtText(this.currentDt));

    var calendarContainer = calendarInfoContainer.find(".calendar-day-container");
    calendarContainer.empty();

    var calendarStartDt = moment(currentDt).startOf('w');
    var calendarEndDt = moment(currentEndDt).subtract(1, 's').endOf('w');
    for (var calendarNowDt=calendarStartDt; calendarNowDt.isBefore(calendarEndDt); calendarNowDt.add(1, 'd')) {
        var calendarDayEle = $("<div class='calendar-day'></div>");
        calendarDayEle.append("<div class='calendar-day-digit'>"+calendarNowDt.date()+"</div>");

        if (calendarNowDt.isBefore(currentDt)
            || calendarNowDt.isSame(currentEndDt)
            || calendarNowDt.isAfter(currentEndDt)) {
            calendarDayEle.addClass('calendar-day-out-range');
        } else if (isNotConcernFunc(calendarNowDt)) {
            calendarDayEle.addClass('calendar-day-not-concern');
        } else {
            var diffPercent;
            if (calendarNowDt.unix() in readings) {
                diffPercent = (readings[calendarNowDt.unix()]-averageUsage)/averageUsage*100;
            } else {
                diffPercent = 0;
            }
            diffPercent = parseFloat(Utils.fixedDecBaseOnVal(diffPercent));

            var diffPercentText;
            if (diffPercent >= 0) {
                diffPercentText = "<span class='calendar-day-plus-symbol'>+</span> "+diffPercent;
            } else {
                diffPercentText = "<span class='calendar-day-minus-symbol'>-</span> "+Math.abs(diffPercent);
            }
            if (diffPercent >= 5) {
                calendarDayEle.addClass('calendar-day-worse');
            } else if (diffPercent <= -5) {
                calendarDayEle.addClass('calendar-day-better');
            }
            calendarDayEle.append("<div class='calendar-day-percent'>"
                +diffPercentText
                +"<span class='calendar-day-percent-symbol'>%</span></div>");
        }

        calendarContainer.append(calendarDayEle);
    }
}


getReportData = function() {
    var report_data;
    var requestData = {
        report_type: 'month',
        start_timestamp: {{ report_start|date:"U" }},
        end_timestamp: {{ report_end|date:"U" }}
    };

    $.ajax({
        type: "POST",
        url: "/{{ company_system.code }}/report_data/",
        data: requestData,
        async: false
    })
    .done(function(data) {
        report_data = data;
    });

    return report_data
}

$(document).ready(function()  {

    // using jQuery
    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    var csrftoken = getCookie('csrftoken');

    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


    // var report_data = getReportData();
    var report_data = {{ report_data_json|safe }};

    var report_readings = {};
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        $.each(info.currentReadings, function(timestamp, readingVal) {
            report_readings[timestamp] = ((timestamp in report_readings) ? report_readings[timestamp] : 0) + readingVal;
        });
    });

    //average uage
    var average_usage = 0;
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        average_usage += info['currentWeekdayInfo'].average;
    });

    var holidays = {{ holidays_json|safe }};

    // for weekday report
    var isNotConcernFunc = function(targetDt) {
        return (targetDt.day() == 0
            || targetDt.day() == 6
            || ($.inArray(targetDt.format("YYYY-MM-DD"), holidays) != -1))
            // || ($.inArray(targetDt.format("YYYY-MM-DD"), reportGenThis.holidays) != -1))
    }

    var report_start = new Date("{{ report_start.isoformat }}");
    var report_end = new Date("{{ report_end.isoformat }}");

    setCalendar(
        report_start, report_end,
        '#weekday-info .calendar-info-container', report_readings, average_usage, isNotConcernFunc);

    $('#weekday-info .average-usage').html(average_usage);


    var weekend_average_usage = 0;
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        weekend_average_usage += info['currentWeekendInfo'].average;
    });

    var isNotConcernFunc = function(targetDt) {
        return (targetDt.day() >= 1
            && targetDt.day() <= 5
            && ($.inArray(targetDt.format("YYYY-MM-DD"), holidays) == -1))
    }

    setCalendar(
        report_start, report_end,
        '#weekend-info .calendar-info-container', report_readings, weekend_average_usage, isNotConcernFunc);

    var combinedOvernightCurrentReadings = {};
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        $.each(info.overnightcurrentReadings, function(timestamp, readingVal) {
            combinedOvernightCurrentReadings[timestamp] =
                ((timestamp in combinedOvernightCurrentReadings) ? combinedOvernightCurrentReadings[timestamp] : 0) + readingVal;
        });
    });

    var isNotConcernFunc = function(targetDt) {
        return false;
    }

    var overnight_average_usage = 0;
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        overnight_average_usage += info['currentOvernightInfo'].average;
    });

    setCalendar(
        report_start, report_end,
        '#overnight-info .calendar-info-container', combinedOvernightCurrentReadings, overnight_average_usage, isNotConcernFunc);

    // $('#weekday-info .average-usage').html(average_usage);

    /*
    var overnight_readings = {};
    $.each(report_data.groupedSourceInfos, function(groupIdx, info) {
        $.each(info.overnightcurrentReadings, function(timestamp, readingVal) {
            overnight_readings[timestamp] =
                ((timestamp in combinedOvernightCurrentReadings) ? overnight_readings[timestamp] : 0) + readingVal;
        });
    });
    */


    // $('#monthly-report-content div').each(function() {
    //     var a = $(this).find('.menu-target:first');
    //     var m = $(this).find('.menu-content:first').kendoContextMenu({
    //         orientation: 'horizontal',
    //         target: a,
    //         showOn: 'click'
    //     });
    // });
});
    </script>
  </body>
</html>
