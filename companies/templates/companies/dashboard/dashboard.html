{% extends "page_base.html" %}

{% load i18n %}
{% load entrak_extras %}
{% load static %}
{% load humanize %}

{% block ga_page_title %}report{% endblock %}

{% block extra_head %}
{{block.super}}
{% get_current_language as LANGUAGE_CODE %}

<link rel="stylesheet" type="text/css" href="{% static 'css/drop-down-panel.css' %}">

<script src="{% static 'js/jquery-cookie-master/jquery.cookie.js' %}"></script>
<script src="{% static 'js/csrf_ajax.js' %}"></script>
<script src="{% static 'js/moment-with-locales.js' %}"></script>
<script src="{% static 'js/moment-timezone-with-data.min.js' %}"></script>
<script src="{% static 'js/entrak-system.js' %}"></script>
<script src="{% static 'js/entrak-utils.js' %}"></script>
<script src="{% static 'js/report-generator.js' %}"></script>

<link href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'css/tmp/bootstrap_hack.css' %}" rel="stylesheet">
<link href="{% static 'assets/kendoui/styles/kendo.common.min.css' %}" rel="stylesheet">
<link href="{% static 'css/kendo.entrak.theme.css' %}" rel="stylesheet">

<link href="{% static 'assets/kendoui/styles/kendo.dataviz.min.css' %}" rel="stylesheet">
<link href="{% static 'assets/kendoui/styles/kendo.dataviz.default.min.css' %}" rel="stylesheet"
<!-- Because now using jquery v1.11 -->
<!-- <script src="{% static 'assets/kendoui/js/angular.min.js' %}"></script> -->
<!-- <script src="{% static 'assets/kendoui/js/kendo.all.min.js' %}"></script> -->
<script src="{% static 'assets/etkendoui/js/et.datepicker.js' %}"></script>
<script src="{% static 'assets/etkendoui/js/cultures/kendo.culture.zh-TW.js' %}"></script>

<link rel="stylesheet" type="text/css" href="{% static 'css/dashboard/widgets.css' %}">


{% endblock %}

{% block selected-menu-link-id %}menu-link-report{% endblock %}
{% block system_menu_target_view %}report{% endblock %}
{% block breadcrumb_target_view %}report{% endblock %}

{% block page_title %}{% trans "THE REPORTS PAGE" %}{% endblock %}
{% block page_subtitle %}{% trans "Get all your information here at the" %}{% endblock %}

{% block page_content %}

<div class="container" ng-app="Entrak">
    <div class="row">
        <div class="col-md-8">
            {% include "companies/dashboard/widgets/_real_time.html" with widget_id=4 %}
        </div>
        <div class="col-md-4">
            {% include "companies/dashboard/widgets/_tips.html" with widget_id=3 %}
        </div>
    </div>
    <div class="row">
        <div class="col-md-4">
          {% include "companies/dashboard/widgets/_biggest_consumers.html" with widget_id=1 %}
        </div>
        <div class="col-md-4">
          {% include "companies/dashboard/widgets/_so_far.html" with widget_id=2 %}
        </div>
        <div class="col-md-4">
          {% include "companies/dashboard/widgets/_last_week_stats.html" with widget_id=5 %}
        </div>
    </div>
</div>

<script>
    function to_ampm(h) {
        var ampm = h;
        if (ampm > 12) {
            ampm -= 12;
        }
        else if (ampm == 0) {
            ampm = 12
        }

        return ampm
    }

    var ngapp = angular.module("Entrak", [ "kendo.directives" ]);

    ngapp.filter('abs', function () {
        return function(val) {
            return Math.abs(val);
        }
    });

    ngapp.controller("WidgetRealtime", function($scope) {
        var today_measures = [];
        var last_week_measures = [];
        for (var i = 0; i < 24; i++) last_week_measures[i] = null;


        var refreshChartAxis = function(){
            var max_today = Math.max.apply(null, today_measures);
            var max_last = Math.max.apply(null, last_week_measures);
            var maxValue = Math.max(max_today, max_last);

            // find the nearest 10, 100, 1000... based interget
            var pow = (maxValue+".").indexOf(".") - 1;
            var maxStep = Math.ceil(maxValue/Math.pow(10, pow)) * Math.pow(10, pow);

            var step = maxStep / 4;
            $scope.realTimeChart.setOptions({valueAxis: {max: maxStep, majorUnit: step}});
        }

        var today_measure_ds = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "{% url 'companies.measures.daily' current_system.code %}",
                    type: 'GET',
                    dataType: "json"
                },
                parameterMap: function(data, type) {
                    if (type == "read") {
                        var d = data.date;
                        if (d === undefined) { d = new Date(); }

                        return {
                            date: kendo.toString(d, 'yyyy-MM-dd')
                        }
                    }
                }
            },
            schema: {
                model: {
                    fields: {
                        datetime: { type: "date"}
                    }
                }
            }
        });

        var total_ds = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "{% url 'companies.measures.total' current_system.code %}",
                    type: 'GET',
                    dataType: "json"
                }
            },
            schema: {
                    // Fix for single result
                    data: function(response) {
                        return [response];
                    }
                }
        });

        var hours = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23];
        var per_hour_measures = {};
        $.each(hours, function(i, h) { per_hour_measures[h] = null; });
        //$.each(hours, function(i, h) { per_hour_measures[h] = h*5+123; });

        $scope.realTimeSelect = 'graph';
        $scope.realTimeOptions = {
            transitions: false,
            chartArea: {
                height: 200,
                margin: 0,
                background: "#FCFCFC"
            },
            series: [{
                type: "column",
                name: "Today",
                color: "#81d51d",
                gap: 1.2,
                overlay: {
                    gradient: "none"
                },
                border: {
                    width: 0
                },
                data: today_measures
            }, {
                type: "line",
                name: "Last Wed",
                color: "#565656",
                data: last_week_measures
            }],
            legend: {
                visible: false
            },
            categoryAxis: {
                categories: hours,
                labels: {
                    step: 2,
                    font: "0.857em ITCAvantGardeStd-Bk",
                    color: "#4B4B4B",
                    template: "#= to_ampm(value) #"
                },
                line: {
                    visible: true,
                    width: 2,
                    color: "#ECECEC"
                },
                majorGridLines: {
                    visible: false
                },
                majorTicks: {
                    size: 0
                }
            },
            valueAxis: {
                line: {
                    visible: false
                },
                labels: {
                        format: "{0}",
                        font: "0.857em ITCAvantGardeStd-Bk",
                        color: "#4B4B4B"
                    },
                min: 0
            }

        }

        // get last week data
        var last_week_date = new Date();
        last_week_date.setDate(last_week_date.getDate()-7);

        today_measure_ds.read({date: kendo.toString(last_week_date, 'yyyy-MM-dd')}).then(function() {
            var data = today_measure_ds.data();
            $.each(data, function(index, m) {
                var hour = m.datetime.getHours();
                last_week_measures[hour] = m.value;
            });
        });

        $scope.updateTodayMeasure = function () {
            today_measure_ds.read().then(function() {
                var data = today_measure_ds.data();
                $.each(data, function(index, m) {
                    var hour = m.datetime.getHours();
                    if (per_hour_measures[hour] === null) {
                        per_hour_measures[hour] = m.value;
                    }
                });

                today_measures.length = 0;
                $.each(per_hour_measures, function(h, v) { today_measures.push(v); });
                refreshChartAxis();
                $scope.realTimeChart.refresh();
            });

            total_ds.read().then(function() {
                var data = total_ds.data();
                $scope.$apply(function(){
                    $scope.total_cost = data[0].cost;
                });
            });
        }

        $scope.updateRates = function () {
            var date_end = new Date();
            var date_start = new Date();
            date_start.setDate(date_start.getDate() -1);

            total_ds.read({
                date_start: date_start.getTime(),
                date_end: date_end.getTime()
            }).then(function() {
                var data = total_ds.data();
                $scope.$apply(function(){
                    $scope.total_per_day = data[0];
                });
            });

        }

        $scope.toggle = function(isGraph){
            $scope.isGraph = isGraph;
            if (isGraph){
                $scope.updateTodayMeasure();
            } else {
                $scope.updateRates();
            }
        }
        $scope.toggle(true);

        // update the chart every 10 sec
        setInterval(function(){
            $scope.updateTodayMeasure();
        }, 10000);
    });

    ngapp.controller("WidgetBiggestConsumers", function($scope){

        var refreshIntervalId;
        var refreshPeriod = 30000;

        $scope.consumers = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "{% url 'companies.measures.top-three' current_system.code %}",
                    type: 'GET',
                    dataType: "json"
                },
                parameterMap: function(data, type) {
                    if (type == "read") {
                        var d = data["datetime"];
                        var t = data["type"];
                        if (d === undefined) { d = new Date(); }
                        if (t === undefined) { t = "weekly"; }

                        return {
                            datetime: d.toISOString(),
                            type: t
                        }
                    }
                },
            },
            sort: { field: "rank", dir: "dsc" }
        });

        $scope.consumers.read();

        $scope.isWeek = true;
        $scope.toggle = function(clickWeek){

            $scope.isWeek = clickWeek;
            clearInterval(refreshIntervalId);

            var retrieve_type = ($scope.isWeek ? "weekly" : "monthly");

            $scope.consumers.read({type:retrieve_type});
            refreshIntervalId = setInterval(function() { $scope.consumers.read({type:retrieve_type}); }, refreshPeriod);
        };


        $scope.colorClass = function(percentage_change){
            return (percentage_change > 0) ? "red-text" : "green-text";
        };

        refreshIntervalId = setInterval(function() { $scope.consumers.read(); }, refreshPeriod);

    });

    ngapp.controller("WidgetTips", function($scope){
        var tipsList = [{
            shortDesc: "Put a ribbon on it",
            longDesc: "Tie a ribbon to the vent of each aircon unit so you can easily tell if aircon has actually been turned off.",
            imgPath: "/static/images/dashboard/tips-ribbon.png"
        },
        {
            shortDesc: "Label your plugs",
            longDesc: "Label your plugs so you can unplug appliances without accidentally turning off important things!",
            imgPath: "/static/images/dashboard/tips-button.png"
        },
        {
            shortDesc: "Remove a tube",
            longDesc: "If you have more light than you need in an area, you can remove one light tube to save energy!",
            imgPath: "/static/images/dashboard/tips-lightbulbs.png"
        },
        {
            shortDesc: "Turn off the socket",
            longDesc: "Even if an appliance is off, it can still consume 10% of normal energy. Remember to turn off the socket switch too!",
            imgPath: "/static/images/dashboard/tips-switch-off.png"
        },
        {
            shortDesc: "Adjust aircon tomperature",
            longDesc: "30 minutes after turning on aircon, adjust the temperature to minimize energy wastage.",
            imgPath: "/static/images/dashboard/tips-temperature.png"
        }];

        var update = function(){
            $scope.shortDesc = tipsList[$scope.curTips].shortDesc;
            $scope.longDesc = tipsList[$scope.curTips].longDesc;
            $scope.imgPath = tipsList[$scope.curTips].imgPath;
        };

        $scope.curTips = 0;
        update();

        $scope.showNext = function(goNext){
            $scope.curTips += goNext;
            if ($scope.curTips >= tipsList.length){
                $scope.curTips = 0;
            } else if ($scope.curTips < 0){
                $scope.curTips = tipsList.length - 1;
            }

            update();
        }
    });


    ngapp.controller("WidgetSoFar", function($scope){
        var refreshIntervalId;
        var refreshPeriod = 30000;

        var costs = new kendo.data.DataSource({
            transport: {
                read: {
                    url: "{% url 'companies.measures.up-till-now' current_system.code %}",
                    type: 'GET',
                    dataType: "json"
                },
                parameterMap: function(data, type) {
                    if (type == "read") {
                        var d = data["datetime"];
                        var t = data["type"];
                        if (d === undefined) { d = new Date(); }
                        if (t === undefined) { t = "weekly"; }

                        return {
                            datetime: d.toISOString(),
                            type: t
                        }
                    }
                }
            }
        });

        var thisCost = [];
        var lastCost = [];
        var updateChart = function(isInit){
            var data = costs.data();
            thisCost.length = 0;
            lastCost.length = 0;
            for (var i=0; i<data.length; i++){
                if (data[i].is_today){
                    thisCost.push(data[i].value);
                } else {
                    lastCost.push(data[i].value);
                }
            }
            var yMax = Math.max(thisCost[0], lastCost[0]) / 0.85;  //give move space to the text
            $scope.soFarChartThis.setOptions({valueAxis: {max: yMax}}); //use same scale for both chart
            $scope.soFarChartLast.setOptions({valueAxis: {max: yMax}});
            $scope.soFarChartThis.refresh();
            $scope.soFarChartLast.refresh();
        }

        var ca = {
            height: 230,
            margin: 0,
            background: '#FCFCFC'
        };
        var le = {
            visible: false,
            position: 'bottom'
        };
        var sd = {
            type: 'column'
        };
        var va = {
            visible: false,
            line: {
                visible: false
            },
            majorGridLines: {
                visible: false
            },
            min: 0
        };
        var catAxis = {
            visible: true,
            line: {
                visible: true,
                width: 2,
                color: "#D3D3D3"
            },
            majorGridLines: {
                visible: false
            },
            majorTicks: {
                size: 0
            }
        };

        $scope.soFarOptionsThis = {
            series: [{
                markers: { visible: true },
                data: thisCost,
                color: '#354960',
                opacity: 0.6,
                gap: 0.1,
                overlay: {
                    gradient: "none"
                },
                border: {
                    width: 0
                },
                labels: {
                    visible: true,
                    font: "bold 1.357em ITCAvantGardeStd-Bk",
                    color: "#354960",
                    format: "$ ##,#"
                }
            }],
            chartArea: ca,
            legend: le,
            seriesDefaults: sd,
            valueAxis: va,
            categoryAxis: catAxis
        }
        $scope.soFarOptionsLast = {
            series: [{
                markers: { visible: true },
                data: lastCost,
                color: '#7a7a7a',
                opacity: 0.6,
                gap: 0.1,
                overlay: {
                    gradient: "none"
                },
                border: {
                    width: 0
                },
                labels: {
                    visible: true,
                    font: "bold 1.357em ITCAvantGardeStd-Bk",
                    color: "#878787",
                    format: "$ ##,#"
                }
            }],
            chartArea: ca,
            legend: le,
            seriesDefaults: sd,
            valueAxis: va,
            categoryAxis: catAxis
        }


        $scope.isWeek = true;
        var setTitle = function(){
            $scope.leftBoxTitle = $scope.isWeek ? "So far this week" : "So far this month";
            $scope.rightBoxTitle = $scope.isWeek ? "By this time last week" : "By this time last month";
        }

        setTitle();

        $scope.toggle = function(isWeek) {
            $scope.isWeek = isWeek;
            setTitle();
            clearInterval(refreshIntervalId);

            var retrieve_date = new Date();
            var retrieve_type = ($scope.isWeek ? "weekly" : "monthly");

            costs.read({datetime:retrieve_date, type:retrieve_type}).then(updateChart);
            refreshIntervalId = setInterval(function() { 
                costs.read({datetime:retrieve_date, type:retrieve_type}).then(updateChart);
            }, refreshPeriod);
        }

        costs.read().then(updateChart);
        refreshIntervalId = setInterval(function() {
            costs.read().then(updateChart);
        }, refreshPeriod);
    });

    ngapp.controller("WidgetLastWeekStats", function($scope){
    });
</script>

{% endblock %}
