{% extends "page_base.html" %}

{% load i18n %}
{% load entrak_extras %}
{% load static %}
{% load humanize %}

{% block ga_page_title %}report{% endblock %}

{% block extra_head %}
{{block.super}}
{% get_current_language as LANGUAGE_CODE %}

<link rel="stylesheet" type="text/css" href="{% static 'css/drop-down-panel.css' %}">

<script src="{% static 'js/jquery-cookie-master/jquery.cookie.js' %}"></script>
<script src="{% static 'assets/django/js/ajax.js' %}"></script>
<script src="{% static 'js/moment-with-locales.js' %}"></script>
<script src="{% static 'js/moment-timezone-with-data.min.js' %}"></script>
<script src="{% static 'js/entrak-system.js' %}"></script>
<script src="{% static 'js/entrak-utils.js' %}"></script>
<script src="{% static 'js/report-generator.js' %}"></script>

<link href="{% static 'assets/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">
<link href="{% static 'css/tmp/bootstrap_hack.css' %}" rel="stylesheet">
<link href="{% static 'css/companies/report_schedule.css' %}" rel="stylesheet">

<script src="{% static 'assets/etkendoui/js/et.datepicker.js' %}"></script>
<script src="{% static 'assets/etkendoui/js/cultures/kendo.culture.en-US.js' %}"></script>
<script src="{% static 'assets/etkendoui/js/cultures/kendo.culture.zh-TW.js' %}"></script>

{% endblock %}

{% block selected-menu-link-id %}menu-link-export{% endblock %}
{% block system_menu_target_view %}report{% endblock %}
{% block breadcrumb_target_view %}report{% endblock %}

{% block page_title %}{% trans "THE DOWNLOAD PAGE" %}{% endblock %}
{% block page_subtitle %}{% trans "Get all your information here at the" %}{% endblock %}

{% block extra_script %}
{{block.super}}
{% endblock %}

{% block page_content %}

{% verbatim %}
<div ng-app="Entrak">
    <div ng-cloak ng-controller="ReportScheduleController" class="auto-report-base" style="height: 420px">
        <div class="row steps">
            <div class="col-md-3 description">
                <p class="desc-text">{{description}}</p>
                <img src="/static/images/report-schedule/report-icon.png"></img>
            </div>
            <div class="col-md-3">
                <div class="step-label">{{step1}}</div>
                <div class="header">{{step1Title}}</div>
                <div class="content bg-step1">
                    <div class="label-top"></div>
                    <select kendo-drop-down-list="systemDropdown"
                            k-data-text-field="'fullname'"
                            k-data-value-field="'id'"
                            k-data-source="systemsDataSource"></select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step-label">{{step2}}</div>
                <div class="header">{{step2Title}}</div>
                <div class="content bg-step2">
                    <div class="label-top"></div>
                    <select kendo-drop-down-list="frequencyDropdown"
                            k-data-text-field="'name'"
                            k-data-value-field="'id'"
                            k-data-source="frequencyDataSource"></select>
                    </select>
                </div>
            </div>
            <div class="col-md-3">
                <div class="step-label">{{step3}}</div>
                <div class="header">{{step3Title}}</div>
                <div class="content bg-step3">
                    <h4 class="label-top">{{sendTo}}</h4>
                    <div id="rs-emailList"></div>
                    <input ng-model="taskEmail" >
                    <div>
                        <button ng-click="confirmAdd()">{{btnConfirm}}</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row records">
            <div class="col-md-12">
                <div class="header">{{recordTitle}}</div>
                <div kendo-grid k-options="taskGridOptions(dataItem)"></div>
            </div>
        </div>
    </div>
</div>
{% endverbatim %}

<script>
    angular.module("Entrak", [ "kendo.directives" ])
        .controller("ReportScheduleController", function($scope) {
            var EtDropDown = function(elm, data){
                var that = this,
                body = document.body,
                keys = kendo.keys,
                support = kendo.support,
                ARIA_HIDDEN = "aria-hidden",
                EMPTYITEMLIST = '<div class="k-itemList"></div><div class=""><input></input><button class="add-btn">Add</button></div>',
                SPAN = "<SPAN/>",
                ns = ".kendoEtDropDown",
                MOUSEDOWN = "mousedown" + ns,
                KEYDOWN = "keydown" + ns,
                CLICK = "click" + ns;
                
                that.wrapper = '<SPAN unselectable="on" class="k-widget k-dropdown k-header"><SPAN unselectable="on" class="k-dropdown-wrap k-state-default">'
                            + '<SPAN unselectable="on" class="k-input"></SPAN>' 
                            + '<SPAN unselectable="on" class="k-select"><SPAN unselectable="on" class="k-icon k-i-arrow-s"></SPAN></SPAN>'
                            + '</SPAN></SPAN>';

                that.wrapper = $(that.wrapper);
                that.wrapper.appendTo(elm);

                that.value(data);

                that.container = $("<DIV/>").attr(ARIA_HIDDEN, "true").addClass("k-et-dropdown-container").appendTo(body);
                var options = {};
                options.animation = {};
                options.name = "Popup";
                options.isRtl = kendo.support.isRtl(options.anchor);
                options.anchor = that.wrapper;

                that.popup = new kendo.ui.Popup(that.container, options);

                var div = $("<DIV/>").attr("id", kendo.guid()).appendTo(that.popup.element);//.on(MOUSEDOWN, preventDefault);
                div.html(EMPTYITEMLIST);

                that.container.on(KEYDOWN, function(e){
                    if (e.keyCode == keys.ESC) {
                        that.popup.close();
                        return;
                    }
                });

                that.container.find(".add-btn").on(CLICK, function(){
                    if (that.addItem(that.container.find("INPUT").val())){
                        that.container.find("INPUT").val("");
                        that.updatePopup();
                    }
                });

                that.container.find(".k-itemList").on(CLICK, function(e){
                    var target = $(e.target);
                    if (target.hasClass("k-select") || target.hasClass("k-icon")){
                        var item = target.closest("DIV").find("span:first").text();
                        that.removeItem(item);
                        that.updatePopup();
                    }
                });
                
                that.wrapper.on(MOUSEDOWN, function(){
                    if (that.popup.visible()){
                        that.close();
                    } else {
                        that.open();    
                    }
                });

            };

            EtDropDown.prototype = {
                ITEM: '<DIV><SPAN></SPAN><SPAN class="k-select"><SPAN class="k-icon k-i-arrow-s"></SPAN></SPAN></DIV>',

                value: function(data){
                    if (data == null){
                        return this.items;
                    } else if ($.isArray(data)){
                        this.items = data;
                    } else {
                        this.items = [data];
                    }
                },

                addItem: function(item){
                    if (item && item.trim()){
                        item = item.trim();
                        if (this.items.indexOf(item) == -1){
                            this.items.push(item);
                            this.updateTextbox();
                            return true;
                        }
                    }
                    return false;
                },

                removeItem: function(item){
                    if (item){
                        var i = this.items.indexOf(item);
                        if (i != -1){
                            this.items.splice(i, 1);
                        }
                        this.updateTextbox();
                    }
                },

                updatePopup: function(){
                    var list = $(this.popup.element).find(".k-itemList");
                    list.html("");

                    for (var i=0; i<this.items.length; i++){
                        var item = $(this.ITEM);
                        item.find("span:first").html(this.items[i]);
                        item.appendTo(list);
                    }
                },

                updateTextbox: function(){
                    if (this.items.length == 1){
                        this.wrapper.find(".k-input").text(this.items[0]);
                    } else {
                        this.wrapper.find(".k-input").text(this.items.length + " Users");
                    }
                },

                readOnly: function(readonly){
                    this.wrapper.attr("aria-readonly", readonly);
                },

                open: function(){
                    if (this.wrapper.attr("aria-readonly") == "true")
                        return;

                    var input = this.container.find("INPUT");
                    this.updatePopup();
                    input.val("");
                    this.popup.open();
                    setTimeout(function(){
                        input.focus();
                    }, 200);
                },

                close: function(){
                    this.popup.close();
                }
            }

            var etDropDown = new EtDropDown($("#rs-emailList"), ["asdf@hahah.com", "bbb@yahoo.com"]);
            console.log(etDropDown.value());
            etDropDown.value(["1@hahah.com", "2@yahoo.com"]);
            etDropDown.addItem("yahoo@gmail.com");
            console.log(etDropDown.value());
            etDropDown.readOnly(true);

            $scope.description = '{% trans "Set the system to email you an energy report each month or week, so you can stay informaed and up to date on your energy use." %}';
            $scope.btnConfirm = '{% trans "Confirm" %}';
            $scope.sendTo = '{% trans "Send to:" %}';
            $scope.step1 = '{% trans "Step 1" %}';
            $scope.step2 = '{% trans "Step 2" %}';
            $scope.step3 = '{% trans "Step 3" %}';
            $scope.step1Title = '{% trans "Select Scope" %}';
            $scope.step2Title = '{% trans "Select Frequency" %}';
            $scope.step3Title = '{% trans "Confirm and Go" %}';

            $scope.recordTitle = '{% trans "Manage Automated Reports" %}';

            var userDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        async: false,
                        url: "{% url 'companies.users.authenticated-user' current_system.code %}",
                        type: 'GET',
                        dataType: "json"
                    }
                },
                schema: {
                    // Fix for single result
                    data: function(response) {
                        return [response];
                    }
                }
            });

            userDataSource.read();
            var authenticated_user = userDataSource.data()[0];
            if (authenticated_user){
                $scope.taskEmail = authenticated_user.email; // set default task value
            } else {
                $scope.taskEmail = "";
            }
            

            $scope.systemsDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        async: false,
                        url: "{% url 'companies.systems.company-systems' current_system.code %}",
                        type: 'GET',
                        dataType: "json"
                    }
                }
            });

            $scope.frequencyDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        async: false,
                        url: "{% url 'companies.report-schedule.frequencies' current_system.code %}",
                        type: 'GET',
                        dataType: "json"
                    }
                }
            });


            $scope.systemsDataSource.read();
            var company_systems = $scope.systemsDataSource.data();

            $scope.frequencyDataSource.read();
            var frequencies = $scope.frequencyDataSource.data();


            var scheduleTaskDataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        url: "{% url 'companies.report-schedule.tasks' current_system.code %}"
                    },
                    create: {
                        url: "{% url 'companies.report-schedule.create' current_system.code %}",
                        type: "POST",
                        contentType: "application/json"
                    },
                    update: {
                        url: function (item) {
                            var url = "{% url 'companies.report-schedule.update' current_system.code 999 %}";
                            return url.replace(999, item.id);
                        },
                        type: "PUT",
                        contentType: "application/json"
                    },
                    destroy: {
                        url: function (item) {
                            var url = "{% url 'companies.report-schedule.destroy' current_system.code 999 %}";
                            url = url.replace(999, item.id);
                            return url;
                        },
                        type: "DELETE"
                    },
                    parameterMap: function(data, type) {
                        if (type == "create") {
                            return kendo.stringify(data);
                        }
                        if (type == "update") {
                            return kendo.stringify(data);
                        }
                    }
                },
                schema: {
                    model: { id: "id" } // identifier for map to kendo model, must be defined for create, update or delete
                }
            });

            $scope.confirmAdd = function() {
                scheduleTaskDataSource.add(
                    {
                        frequency_id: $scope.frequencyDropdown.value(),
                        system_id: $scope.systemDropdown.value(),
                        receivers: [{"email": $scope.taskEmail}]
                    });
                scheduleTaskDataSource.sync();
            };

            $scope.taskGridOptions = function(dataItem) {
                return {
                    dataSource: scheduleTaskDataSource,
                    columns: [
                        { field: "frequency_id", title:"frequency", width: "110px", editor: frequencyDropDownEditor,
                          template: function(dataItem) {
                              return $.grep(frequencies, function(e) {
                                  return e.id == dataItem.frequency_id
                              })[0].name;
                          }
                        },
                        { field: "system_id", title:"system", width: "110px", editor: systemDropDownEditor,
                          template: function(dataItem) {
                              return $.grep(company_systems, function(e) {
                                  return e.id == dataItem.system_id
                              })[0].fullname;
                          }
                        },
                        { title: "Receivers",
                          template: function(dataItem) {
                              var arr = $.map(dataItem.receivers, function(r) { return r.email; });
                              return arr.join(',');
                          }
                        },
                        { command: ["edit", "destroy"], title: "&nbsp;", width: "250px" }
                    ],
                    editable: "inline"
                };
            };

            function systemDropDownEditor(container, options) {
                $('<input required data-text-field="fullname" data-value-field="id" data-bind="value:' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        autoBind: false,
                        dataSource: $scope.systemsDataSource
                    });
            }

            function frequencyDropDownEditor(container, options) {
                $('<input required data-text-field="name" data-value-field="id" data-bind="value:' + options.field + '"/>')
                    .appendTo(container)
                    .kendoDropDownList({
                        autoBind: false,
                        dataSource: $scope.frequencyDataSource
                    });
            }

    });
</script>
{% endblock %}
